{% extends "custom_admin/base.html" %}
{% block title %}
Admin Dashboard
{% endblock title %}

{% block content %}
<style>
  #sales-chart {
    max-width: 1200px; /* Adjust width as needed */
    height: 600px;    /* Adjust height as needed */
    margin: 0 auto;   /* Center align horizontally */
  }
  .hi {
    min-height: 400px; /* Or any desired fixed height */
    display: flex;
    flex-direction: column;
  }

  .card-body {
    flex-grow: 1;  /* Makes body fill the card height */
    max-height: 640px; /* Adjust if needed */
    overflow-y: auto;  /* Enables vertical scroll if content overflows */
  }
</style>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/chartist.js/latest/chartist.min.css">

<main class="col-md-10">
  <div class="mb-3 mt-2">
    <a href="{% url 'download_sales_report_pdf' %}" class="btn btn-sm btn-outline-primary">
        Download Sales Report (PDF)
    </a>
  </div>
  <div class="dashboard-header">
    <h3>Welcome, {{ user.first_name }}</h3>
    <p class="text-muted">Here's what's happening today</p>
  </div>
  <div class="container mt-4">
    <div class="row g-4">
      <!-- Orders Widget -->
      <div class="col-md-3">
        <div class="card text-white bg-primary">
          <div class="card-body">
            <h5 class="card-title">Total Orders</h5>
            <p class="card-text">{{ total_orders }}</p>
          </div>
        </div>
      </div>
      <!-- Sales Widget -->
      <div class="col-md-3">
        <div class="card text-white bg-success">
          <div class="card-body">
            <h5 class="card-title">Total Sales</h5>
            <p class="card-text">â‚¹{{ total_sales }}</p>
          </div>
        </div>
      </div>
      <!-- Completed Orders Widget -->
      <div class="col-md-3">
        <div class="card text-white bg-warning">
          <div class="card-body">
            <h5 class="card-title">Completed Orders</h5>
            <p class="card-text">{{ completed_orders }}</p>
          </div>
        </div>
      </div>
      <!-- Pending Orders Widget -->
      <div class="col-md-3">
        <div class="card text-white bg-danger">
          <div class="card-body">
            <h5 class="card-title">Pending Orders</h5>
            <p class="card-text">{{ pending_orders }}</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Three Top Lists -->
    <div class="row mt-5">
      <!-- Top Products -->
      <div class="col-md-4">
        <div class="card">
          <div class="card-header">Top 10 Products</div>
          <div class="card-body">
            <ul class="list-group">
              {% for prod in top_products %}
                <li class="list-group-item d-flex justify-content-between align-items-center">
                  {{ prod.variant__product__name }}
                  <span class="badge bg-primary rounded-pill">{{ prod.quantity_sold }}</span>
                </li>
              {% endfor %}
            </ul>
          </div>
        </div>
      </div>
      <!-- Top Categories -->
      <div class="col-md-4">
        <div class="card">
          <div class="card-header">Top 10 Categories</div>
          <div class="card-body">
            <ul class="list-group">
              {% for cat in top_categories %}
                <li class="list-group-item d-flex justify-content-between align-items-center">
                  {{ cat.variant__product__category__name }}
                  <span class="badge bg-success rounded-pill">{{ cat.quantity_sold }}</span>
                </li>
              {% endfor %}
            </ul>
          </div>
        </div>
      </div>
      <!-- Top Brands -->
      <div class="col-md-4">
        <div class="card">
          <div class="card-header">Top 10 Brands</div>
          <div class="card-body">
            <ul class="list-group">
              {% for brand in top_brands %}
                <li class="list-group-item d-flex justify-content-between align-items-center">
                  {{ brand.variant__product__brand }}
                  <span class="badge bg-warning rounded-pill">{{ brand.quantity_sold }}</span>
                </li>
              {% endfor %}
            </ul>
          </div>
        </div>
      </div>
    </div>

    <!-- Chart Section -->
    <div class="row mt-5">
      <form method="get" action="" class="d-flex align-items-center mb-3">
        <select name="filter" id="chart-filter" class="form-select me-2" style="width:auto;">
          <option value="daily" {% if selected_filter == "daily" %}selected{% endif %}>Daily</option>
          <option value="monthly" {% if selected_filter == "monthly" %}selected{% endif %}>Monthly</option>
          <option value="yearly" {% if selected_filter == "yearly" %}selected{% endif %}>Yearly</option>
        </select>
        <button type="submit" class="btn btn-primary btn-sm">Update Chart</button>
      </form>

      <div class="col-md-12">
        <div class="card">
          <div class="card-header d-flex justify-content-between align-items-center">
            <span>Sales Chart</span>
          </div>
          <div class="card-body h-50 hello">
            <div id="sales-chart" class="ct-chart ct-perfect-fourth"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</main>

<script src="https://cdn.jsdelivr.net/chartist.js/latest/chartist.min.js"></script>

<script>
// Initial data from Django context (daily by default)
const initialLabels = [{% for day in daily_sales %}'{{ day.date }}',{% endfor %}];
const initialSeries = [{% for day in daily_sales %}{{ day.sales }},{% endfor %}];

// Variable to hold the current chart instance
let chartInstance = null;

function drawChart(labels, series) {
  // Detach existing chart if present
  if (chartInstance) {
    chartInstance.detach();
  }
  chartInstance = new Chartist.Line('#sales-chart', {
    labels: labels,
    series: [series]
  }, {
    showArea: true,
    lineSmooth: false,
    fullWidth: true,
    chartPadding: { right: 40 },
    axisY: { onlyInteger: true, offset: 20, low: 0, scaleMinSpace: 15 }
  });
}

document.addEventListener('DOMContentLoaded', function () {
  drawChart(initialLabels, initialSeries);

  document.getElementById('chart-filter-form').addEventListener('submit', function (event) {
    event.preventDefault();
    const filter = this.elements['filter'].value;

    fetch(`/custom/admin/sales/chart/data/?filter=${filter}`)
      .then(response => {
        if (!response.ok) {
          throw new Error('Network response was not ok');
        }
        return response.json();
      })
      .then(data => drawChart(data.labels, data.sales))
      .catch(error => {
        console.error('Error fetching or rendering chart data:', error);
        // Optionally, display a user-friendly error message here
      });
  });
});
</script>

{% endblock content %}
