{% extends "custom_admin/base.html" %}
{% block title %}Admin Dashboard{% endblock title %}

{% block content %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/chartist.js/latest/chartist.min.css">

<main class="p-6 space-y-8">
  <!-- Download Report -->
  <div>
    <a href="{% url 'download_sales_report_pdf' %}"
       class="inline-block px-4 py-2 text-sm font-medium text-blue-600 border border-blue-500 rounded-md hover:bg-blue-50 transition">
      Download Sales Report (PDF)
    </a>
  </div>

  <!-- Header -->
  <div>
    <h3 class="text-2xl font-semibold text-gray-800">Welcome, {{ user.username|title }}</h3>
    <p class="text-gray-500">Here's what's happening today</p>
  </div>

  <!-- Stats Cards -->
  <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
    <div class="bg-blue-600 text-white p-5 rounded-xl shadow-md">
      <h5 class="text-sm uppercase font-semibold opacity-80">Total Orders</h5>
      <p class="text-3xl font-bold mt-2">{{ total_orders }}</p>
    </div>
    <div class="bg-green-600 text-white p-5 rounded-xl shadow-md">
      <h5 class="text-sm uppercase font-semibold opacity-80">Total Sales</h5>
      <p class="text-3xl font-bold mt-2">â‚¹{{ total_sales }}</p>
    </div>
    <div class="bg-yellow-500 text-white p-5 rounded-xl shadow-md">
      <h5 class="text-sm uppercase font-semibold opacity-80">Completed Orders</h5>
      <p class="text-3xl font-bold mt-2">{{ completed_orders }}</p>
    </div>
    <div class="bg-red-600 text-white p-5 rounded-xl shadow-md">
      <h5 class="text-sm uppercase font-semibold opacity-80">Pending Orders</h5>
      <p class="text-3xl font-bold mt-2">{{ pending_orders }}</p>
    </div>
  </div>

  <!-- Top Lists -->
  <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
    <!-- Top Products -->
    <div class="bg-white rounded-xl shadow-md">
      <div class="border-b px-5 py-3 font-semibold text-gray-800">Top 10 Products</div>
      <div class="p-4 max-h-[400px] overflow-y-auto">
        <ul class="divide-y divide-gray-100">
          {% for prod in top_products %}
            <li class="flex justify-between items-center py-2">
              <span>{{ prod.variant__product__name }}</span>
              <span class="bg-blue-100 text-blue-700 text-xs font-medium px-3 py-1 rounded-full">
                {{ prod.quantity_sold }}
              </span>
            </li>
          {% endfor %}
        </ul>
      </div>
    </div>

    <!-- Top Categories -->
    <div class="bg-white rounded-xl shadow-md">
      <div class="border-b px-5 py-3 font-semibold text-gray-800">Top 10 Categories</div>
      <div class="p-4 max-h-[400px] overflow-y-auto">
        <ul class="divide-y divide-gray-100">
          {% for cat in top_categories %}
            <li class="flex justify-between items-center py-2">
              <span>{{ cat.variant__product__category__name }}</span>
              <span class="bg-green-100 text-green-700 text-xs font-medium px-3 py-1 rounded-full">
                {{ cat.quantity_sold }}
              </span>
            </li>
          {% endfor %}
        </ul>
      </div>
    </div>

    <!-- Top Brands -->
    <div class="bg-white rounded-xl shadow-md">
      <div class="border-b px-5 py-3 font-semibold text-gray-800">Top 10 Brands</div>
      <div class="p-4 max-h-[400px] overflow-y-auto">
        <ul class="divide-y divide-gray-100">
          {% for brand in top_brands %}
            <li class="flex justify-between items-center py-2">
              <span>{{ brand.variant__product__brand }}</span>
              <span class="bg-yellow-100 text-yellow-700 text-xs font-medium px-3 py-1 rounded-full">
                {{ brand.quantity_sold }}
              </span>
            </li>
          {% endfor %}
        </ul>
      </div>
    </div>
  </div>

  <!-- Chart Section -->
  <div class="bg-white rounded-xl shadow-md p-6">
    <form method="get" action="" class="flex items-center gap-3 mb-4" id="chart-filter-form">
      <select name="filter"
              class="border-gray-300 rounded-lg text-sm focus:ring-blue-500 focus:border-blue-500"
              style="width: auto;">
        <option value="daily" {% if selected_filter == "daily" %}selected{% endif %}>Daily</option>
        <option value="monthly" {% if selected_filter == "monthly" %}selected{% endif %}>Monthly</option>
        <option value="yearly" {% if selected_filter == "yearly" %}selected{% endif %}>Yearly</option>
      </select>
      <button type="submit"
              class="px-3 py-1 bg-blue-600 text-white text-sm rounded-lg hover:bg-blue-700 transition">
        Update Chart
      </button>
    </form>

    <div>
      <h4 class="font-semibold text-gray-800 mb-2">Sales Chart</h4>
      <div id="sales-chart" class="ct-chart h-[500px]"></div>
    </div>
  </div>
</main>

<script src="https://cdn.jsdelivr.net/chartist.js/latest/chartist.min.js"></script>

<script>
  const initialLabels = [{% for day in daily_sales %}'{{ day.date }}',{% endfor %}];
  const initialSeries = [{% for day in daily_sales %}{{ day.sales }},{% endfor %}];

  let chartInstance = null;

  function drawChart(labels, series) {
    if (chartInstance) chartInstance.detach();

    chartInstance = new Chartist.Line('#sales-chart', {
      labels: labels,
      series: [series]
    }, {
      showArea: true,
      lineSmooth: false,
      fullWidth: true,
      chartPadding: { right: 40 },
      axisY: { onlyInteger: true, offset: 20, low: 0, scaleMinSpace: 15 }
    });
  }

  document.addEventListener('DOMContentLoaded', function () {
    drawChart(initialLabels, initialSeries);

    const form = document.getElementById('chart-filter-form');
    form.addEventListener('submit', function (e) {
      e.preventDefault();
      const filter = this.elements['filter'].value;

      fetch(`/custom/admin/sales/chart/data/?filter=${filter}`)
        .then(res => res.json())
        .then(data => drawChart(data.labels, data.sales))
        .catch(err => console.error('Error loading chart data:', err));
    });
  });
</script>
{% endblock content %}
