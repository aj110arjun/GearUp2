    {% extends 'custom_admin/base.html' %}

    {% block content %}
    <h2>Add Product</h2>

    <link href="https://unpkg.com/cropperjs@1.5.13/dist/cropper.min.css" rel="stylesheet"/>
    <script src="https://unpkg.com/cropperjs@1.5.13/dist/cropper.min.js"></script>

    <form method="POST" enctype="multipart/form-data" id="product-form">
        {% csrf_token %}
        <div class="mb-3">
            <label>Name</label>
            <input type="text" name="name" class="form-control" required>
        </div>

        <div class="mb-3">
            <label>Description</label>
            <textarea name="description" class="form-control"></textarea>
        </div>

        <div class="mb-3">
            <label>Category</label>
            <select name="category" class="form-control">
                <option value="">-- Select Category --</option>
                {% for cat in categories %}
                    <option value="{{ cat.id }}">{{ cat.name }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="mb-3">
            <label>Brand</label>
            <input type="text" name="brand" class="form-control">
        </div>

        <div class="mb-3">
            <label>Image</label>
            <input type="file" name="image" class="form-control" id="image-input" accept="image/*">
        </div>

        <!-- Preview container for cropping -->
        <div class="mb-3">
            <img id="image-preview" style="max-width:100%; display:none;">
        </div>

        <div class="mb-3">
            <label>
                <input type="checkbox" name="is_active" checked> Active
            </label>
        </div>

        <button type="submit" class="btn btn-success">Save</button>
    </form>

    <script>
    let cropper;
    const input = document.getElementById('image-input');
    const preview = document.getElementById('image-preview');

    input.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;

        const url = URL.createObjectURL(file);
        preview.src = url;
        preview.style.display = 'block';

        if (cropper) cropper.destroy(); // destroy previous cropper
        cropper = new Cropper(preview, {
            aspectRatio: 1, // change to 16/9 if needed
            viewMode: 1,
            autoCropArea: 1,
        });
    });

    // On form submit, replace file with cropped image
    document.getElementById('product-form').addEventListener('submit', function(e) {
        e.preventDefault(); // stop default form submission

        if (cropper) {
            cropper.getCroppedCanvas().toBlob((blob) => {
                const formData = new FormData(this);
                formData.set('image', blob, 'cropped.png'); // replace original image

                // Send form via fetch
                fetch("{% url 'product_add'  %}", {
                    method: 'POST',
                    body: formData,
                }).then(response => {
                    if (response.ok) {
                        window.location.reload(); // or redirect
                    } else {
                        alert('Failed to save product');
                    }
                });
            });
        } else {
            this.submit(); // if no cropper, submit normally
        }
    });
    </script>
    {% endblock %}
