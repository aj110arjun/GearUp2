{% extends 'custom_admin/base.html' %}
{% block title %}Add New Product | Admin Panel - GearUp{% endblock title %}

{% block content %}
<link href="https://unpkg.com/cropperjs@1.5.13/dist/cropper.min.css" rel="stylesheet"/>
<script src="https://unpkg.com/cropperjs@1.5.13/dist/cropper.min.js"></script>

<div class="min-h-screen bg-gray-50 py-6">
  <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
    
    <!-- Header Section -->
    <div class="mb-8">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between">
        <div>
          <nav class="flex mb-4" aria-label="Breadcrumb">
            <ol class="flex items-center space-x-2">
              <li>
                <a href="{% url 'admin_product_list' %}" class="text-gray-500 hover:text-gray-700 text-sm font-medium">Products</a>
              </li>
              <li>
                <svg class="flex-shrink-0 h-5 w-5 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" />
                </svg>
              </li>
              <li>
                <span class="text-gray-700 text-sm font-medium">Add New Product</span>
              </li>
            </ol>
          </nav>
          <h1 class="text-3xl font-bold text-gray-900">Add New Product</h1>
          <p class="mt-2 text-gray-600">Create a new product listing for your store</p>
        </div>
        
        <div class="flex flex-wrap gap-3 mt-4 md:mt-0">
          <a href="{% url 'admin_product_list' %}"
             class="inline-flex items-center px-4 py-2.5 bg-white text-gray-700 text-sm font-medium rounded-lg border border-gray-300 shadow-sm hover:bg-gray-50 transition-all duration-200">
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
            </svg>
            Back to Products
          </a>
        </div>
      </div>
    </div>

    <!-- Main Form -->
    <form method="POST" enctype="multipart/form-data" id="product-form" novalidate>
      {% csrf_token %}
      
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        
        <!-- Left Column - Product Details -->
        <div class="lg:col-span-2 space-y-6">
          
          <!-- Basic Information Card -->
          <div class="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden">
            <div class="border-b border-gray-200 px-6 py-4">
              <h2 class="text-lg font-semibold text-gray-900">Basic Information</h2>
              <p class="text-sm text-gray-600 mt-1">Essential product details and description</p>
            </div>
            <div class="p-6 space-y-6">
              
              <!-- Product Name -->
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                  Product Name <span class="text-red-500">*</span>
                </label>
                <input type="text" name="name" required
                       value="{{ form_data.name|default:'' }}"
                       class="w-full px-4 py-3 border {% if errors.name %}border-red-500 ring-1 ring-red-500{% else %}border-gray-300{% endif %} rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-colors duration-200 placeholder-gray-400"
                       placeholder="Enter product name (e.g., Men's Running Shoes)">
                {% if errors.name %}
                  <p class="text-red-500 text-sm mt-2 flex items-center">
                    <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                      <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                    </svg>
                    {{ errors.name }}
                  </p>
                {% endif %}
              </div>

              <!-- Brand -->
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                  Brand <span class="text-red-500">*</span>
                </label>
                <input type="text" name="brand"
                       value="{{ form_data.brand|default:'' }}"
                       class="w-full px-4 py-3 border {% if errors.brand %}border-red-500 ring-1 ring-red-500{% else %}border-gray-300{% endif %} rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-colors duration-200 placeholder-gray-400"
                       placeholder="Enter brand name (e.g., Nike, Adidas)">
                {% if errors.brand %}
                  <p class="text-red-500 text-sm mt-2 flex items-center">
                    <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                      <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                    </svg>
                    {{ errors.brand }}
                  </p>
                {% endif %}
              </div>

              <!-- Category -->
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                  Category <span class="text-red-500">*</span>
                </label>
                <select name="category" required
                        class="w-full px-4 py-3 border {% if errors.category %}border-red-500 ring-1 ring-red-500{% else %}border-gray-300{% endif %} rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-colors duration-200 bg-white">
                  <option value="">Select a category</option>
                  {% for cat in categories %}
                    <option value="{{ cat.id }}" {% if form_data.category == cat.id|stringformat:"i" %}selected{% endif %}>{{ cat.name }}</option>
                  {% endfor %}
                </select>
                {% if errors.category %}
                  <p class="text-red-500 text-sm mt-2 flex items-center">
                    <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                      <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                    </svg>
                    {{ errors.category }}
                  </p>
                {% endif %}
              </div>

              <!-- Description -->
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                  Description <span class="text-red-500">*</span>
                </label>
                <textarea name="description" rows="5"
                          class="w-full px-4 py-3 border {% if errors.description %}border-red-500 ring-1 ring-red-500{% else %}border-gray-300{% endif %} rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-colors duration-200 placeholder-gray-400 resize-none"
                          placeholder="Describe the product features, specifications, and benefits...">{{ form_data.description|default:'' }}</textarea>
                {% if errors.description %}
                  <p class="text-red-500 text-sm mt-2 flex items-center">
                    <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                      <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                    </svg>
                    {{ errors.description }}
                  </p>
                {% endif %}
              </div>
            </div>
          </div>

          <!-- Product Status Card -->
          <div class="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden">
            <div class="border-b border-gray-200 px-6 py-4">
              <h2 class="text-lg font-semibold text-gray-900">Product Status</h2>
              <p class="text-sm text-gray-600 mt-1">Control product visibility</p>
            </div>
            <div class="p-6">
              <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                <div>
                  <p class="text-sm font-medium text-gray-900">Active Product</p>
                  <p class="text-xs text-gray-600">Make product visible in store</p>
                </div>
                <label class="relative inline-flex items-center cursor-pointer">
                  <input type="checkbox" name="is_active" class="sr-only peer" {% if form_data.is_active or not form_data %}checked{% endif %}>
                  <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-indigo-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-indigo-600"></div>
                </label>
              </div>
            </div>
          </div>
        </div>

        <!-- Right Column - Media & Actions -->
        <div class="space-y-6">
          
          <!-- Product Image Card -->
          <div class="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden">
            <div class="border-b border-gray-200 px-6 py-4">
              <h2 class="text-lg font-semibold text-gray-900">Product Image</h2>
              <p class="text-sm text-gray-600 mt-1">Upload and crop main product image</p>
            </div>
            <div class="p-6">
              
              <!-- File Upload Area -->
              <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-3">
                  Upload Image <span class="text-red-500">*</span>
                </label>
                <div class="flex items-center justify-center w-full">
                  <label for="image-input" class="flex flex-col items-center justify-center w-full h-32 border-2 {% if errors.image %}border-red-500 bg-red-50{% else %}border-dashed border-gray-300 bg-gray-50{% endif %} rounded-lg cursor-pointer hover:bg-gray-100 transition-colors duration-200">
                    <div class="flex flex-col items-center justify-center pt-5 pb-6">
                      <svg class="w-8 h-8 mb-3 {% if errors.image %}text-red-400{% else %}text-gray-400{% endif %}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                      </svg>
                      <p class="mb-1 text-sm {% if errors.image %}text-red-600{% else %}text-gray-500{% endif %}">Click to upload</p>
                      <p class="text-xs {% if errors.image %}text-red-500{% else %}text-gray-500{% endif %}">PNG, JPG, WEBP (Max. 5MB)</p>
                    </div>
                    <input id="image-input" name="image" type="file" accept="image/*" class="hidden" />
                  </label>
                </div>
                {% if errors.image %}
                  <p class="text-red-500 text-sm mt-2 flex items-center">
                    <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                      <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                    </svg>
                    {{ errors.image }}
                  </p>
                {% endif %}
              </div>

              <!-- Cropping Preview -->
              <div id="cropper-section" class="hidden">
                <label class="block text-sm font-medium text-gray-700 mb-3">Crop Image</label>
                <div class="border-2 border-dashed border-gray-300 rounded-lg overflow-hidden">
                  <img id="image-preview" alt="Preview" class="w-full h-64 object-contain bg-gray-50">
                </div>
                <p class="text-xs text-gray-500 mt-2 text-center">Drag to adjust crop area • 1:1 aspect ratio</p>
              </div>

              <!-- Image Guidelines -->
              <div class="mt-4 p-4 bg-blue-50 rounded-lg border border-blue-200">
                <h4 class="text-sm font-medium text-blue-800 mb-2 flex items-center">
                  <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                  </svg>
                  Image Guidelines
                </h4>
                <ul class="text-xs text-blue-700 space-y-1">
                  <li>• Use high-quality, professional product images</li>
                  <li>• Recommended size: 800x800 pixels</li>
                  <li>• Square aspect ratio works best</li>
                  <li>• File formats: JPG, PNG, WEBP</li>
                </ul>
              </div>
            </div>
          </div>

          <!-- Form Actions Card -->
          <div class="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden">
            <div class="border-b border-gray-200 px-6 py-4">
              <h2 class="text-lg font-semibold text-gray-900">Actions</h2>
            </div>
            <div class="p-6 space-y-4">
              <button type="submit"
                      class="w-full inline-flex items-center justify-center px-4 py-3 bg-indigo-600 text-white text-sm font-medium rounded-lg hover:bg-indigo-700 focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition-all duration-200 shadow-sm">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                </svg>
                Create Product
              </button>
              
              <a href="{% url 'admin_product_list' %}"
                 class="w-full inline-flex items-center justify-center px-4 py-3 bg-white text-gray-700 text-sm font-medium rounded-lg border border-gray-300 hover:bg-gray-50 transition-all duration-200">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
                Cancel
              </a>

              <div class="pt-4 border-t border-gray-200">
                <p class="text-xs text-gray-500 text-center">
                  You'll be able to add variants and additional images after creating the product.
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- CropperJS Script -->
<script>
let cropper;
const input = document.getElementById('image-input');
const preview = document.getElementById('image-preview');
const cropperSection = document.getElementById('cropper-section');
const form = document.getElementById('product-form');

// File upload handler
input.addEventListener('change', function (e) {
  const file = e.target.files[0];
  if (!file) return;

  // Validate file size (5MB)
  if (file.size > 5 * 1024 * 1024) {
    alert('File size must be less than 5MB');
    input.value = '';
    return;
  }

  const url = URL.createObjectURL(file);
  preview.src = url;
  cropperSection.classList.remove('hidden');

  // Destroy existing cropper instance
  if (cropper) {
    cropper.destroy();
  }

  // Initialize cropper
  cropper = new Cropper(preview, {
    aspectRatio: 1,
    viewMode: 1,
    autoCropArea: 0.8,
    movable: true,
    zoomable: true,
    rotatable: true,
    scalable: true,
    background: false,
    responsive: true,
    restore: true,
    checkCrossOrigin: false,
    checkOrientation: false,
    modal: true,
    guides: true,
    highlight: true,
    cropBoxMovable: true,
    cropBoxResizable: true,
    toggleDragModeOnDblclick: true,
  });
});

// Form submission handler
form.addEventListener('submit', function (e) {
  e.preventDefault();

  // Basic form validation
  const name = form.querySelector('input[name="name"]').value.trim();
  const brand = form.querySelector('input[name="brand"]').value.trim();
  const category = form.querySelector('select[name="category"]').value;
  const description = form.querySelector('textarea[name="description"]').value.trim();
  
  let hasErrors = false;

  // Clear previous error styles
  document.querySelectorAll('.border-red-500').forEach(el => {
    el.classList.remove('border-red-500', 'ring-1', 'ring-red-500');
  });
  document.querySelectorAll('.text-red-500').forEach(el => {
    if (el.tagName === 'P') el.style.display = 'none';
  });

  // Validate name
  if (!name) {
    showError('name', 'Product name is required.');
    hasErrors = true;
  } else if (name.length < 3) {
    showError('name', 'Product name must be at least 3 characters.');
    hasErrors = true;
  } else if (!/^[A-Za-z0-9 ]+$/.test(name)) {
    showError('name', 'Product name can only contain letters, numbers, and spaces.');
    hasErrors = true;
  }

  // Validate brand
  if (!brand) {
    showError('brand', 'Brand is required.');
    hasErrors = true;
  } else if (!/^[A-Za-z\s]+$/.test(brand)) {
    showError('brand', 'Brand must contain only letters and spaces.');
    hasErrors = true;
  } else if (brand.length < 3) {
    showError('brand', 'Brand must contain at least 3 characters.');
    hasErrors = true;
  }

  // Validate category
  if (!category) {
    showError('category', 'Category is required.');
    hasErrors = true;
  }

  // Validate description
  if (!description) {
    showError('description', 'Description is required.');
    hasErrors = true;
  }

  // Validate image
  if (!input.files.length) {
    showError('image', 'Product image is required.');
    hasErrors = true;
  }

  if (hasErrors) {
    // Scroll to first error
    const firstError = document.querySelector('.border-red-500');
    if (firstError) {
      firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
      firstError.focus();
    }
    return;
  }

  // Handle image cropping if cropper is active
  if (cropper && input.files.length > 0) {
    // Show loading state
    const submitBtn = form.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<svg class="w-4 h-4 mr-2 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 2v4m0 12v4m8-10h-4M6 12H2m16.364-6.364l-2.828 2.828M7.464 17.536l-2.828 2.828m0-11.314l2.828 2.828m9.172 9.172l2.828 2.828"></path></svg> Creating Product...';
    submitBtn.disabled = true;

    cropper.getCroppedCanvas({
      width: 800,
      height: 800,
      fillColor: '#fff',
      imageSmoothingEnabled: true,
      imageSmoothingQuality: 'high'
    }).toBlob((blob) => {
      const formData = new FormData(form);
      formData.set('image', blob, 'product-image.png');

      fetch("{% url 'product_add' %}", {
        method: 'POST',
        body: formData,
        headers: {
          'X-Requested-With': 'XMLHttpRequest'
        }
      })
      .then(response => {
        if (response.ok) {
          window.location.href = "{% url 'admin_product_list' %}";
        } else {
          return response.json().then(data => {
            throw new Error(data.message || 'Failed to create product');
          });
        }
      })
      .catch((error) => {
        console.error('Error:', error);
        alert(error.message || 'Something went wrong while creating the product');
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
      });
    }, 'image/png', 0.9);
  } else {
    // No image selected, submit form normally
    form.submit();
  }
});

// Helper function to show errors
function showError(fieldName, message) {
  const field = document.querySelector(`[name="${fieldName}"]`);
  if (field) {
    field.classList.add('border-red-500', 'ring-1', 'ring-red-500');
    // Find or create error message element
    let errorElement = field.parentElement.querySelector('.text-red-500');
    if (!errorElement) {
      errorElement = document.createElement('p');
      errorElement.className = 'text-red-500 text-sm mt-2 flex items-center';
      errorElement.innerHTML = `<svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>${message}`;
      field.parentElement.appendChild(errorElement);
    } else {
      errorElement.innerHTML = `<svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>${message}`;
      errorElement.style.display = 'flex';
    }
  }
}

// Drag and drop functionality
const dropArea = document.querySelector('label[for="image-input"]');

['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
  dropArea.addEventListener(eventName, preventDefaults, false);
});

function preventDefaults(e) {
  e.preventDefault();
  e.stopPropagation();
}

['dragenter', 'dragover'].forEach(eventName => {
  dropArea.addEventListener(eventName, highlight, false);
});

['dragleave', 'drop'].forEach(eventName => {
  dropArea.addEventListener(eventName, unhighlight, false);
});

function highlight() {
  dropArea.classList.add('border-indigo-400', 'bg-indigo-50');
}

function unhighlight() {
  dropArea.classList.remove('border-indigo-400', 'bg-indigo-50');
}

dropArea.addEventListener('drop', handleDrop, false);

function handleDrop(e) {
  const dt = e.dataTransfer;
  const files = dt.files;
  input.files = files;
  
  // Trigger change event
  const event = new Event('change');
  input.dispatchEvent(event);
}
</script>

<style>
  .peer:checked ~ .peer-checked\:bg-indigo-600 {
    background-color: #4f46e5;
  }
  
  .peer:checked ~ .peer-checked\:after\:translate-x-full:after {
    transform: translateX(100%);
  }
</style>
{% endblock content %}