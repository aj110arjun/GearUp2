{% extends "user/base.html" %}
{% load cart_extras %}
{% block title %} My Cart {% endblock %}

{% block content %}
<script src="https://cdn.tailwindcss.com"></script>

<div class="max-w-7xl mx-auto my-8 px-4">
  <h2 class="text-2xl font-bold mb-4">ðŸ›’ My Cart</h2>
  <hr class="mb-8">

  <!-- Skeleton Loader -->
<div id="cart-skeleton" class="space-y-4">
  <div class="flex items-center space-x-4">
    <div class="w-16 h-16 bg-gray-300 rounded animate-pulse"></div>
    <div class="flex-1 space-y-2">
      <div class="h-4 bg-gray-300 rounded w-3/5 animate-pulse"></div>
      <div class="h-3 bg-gray-300 rounded w-2/5 animate-pulse"></div>
    </div>
  </div>
  <div class="flex items-center space-x-4">
    <div class="w-16 h-16 bg-gray-300 rounded animate-pulse"></div>
    <div class="flex-1 space-y-2">
      <div class="h-4 bg-gray-300 rounded w-4/5 animate-pulse"></div>
      <div class="h-3 bg-gray-300 rounded w-1/2 animate-pulse"></div>
    </div>
  </div>
</div>

  <!-- Actual Cart Content -->
  <div id="cart-content">
    {% if items %}
    <table class="min-w-full divide-y divide-gray-200">
      <thead class="bg-gray-50">
        <tr>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Product</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Variant</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Price</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Quantity</th>
          <th class="px-6 py-3"></th>
        </tr>
      </thead>
      <tbody class="bg-white divide-y divide-gray-200">
        {% for item in items %}
        <tr data-item-id="{{ item.id }}">
          <td class="px-6 py-4 flex items-center space-x-2">
            <img src="{{ item.variant.product.image.url }}" alt="{{ item.variant.product.name }}" class="w-16 h-16 object-cover rounded">
            <span class="truncate max-w-xs">{{ item.variant.product.name }}</span>
          </td>
          <td class="px-6 py-4">
            <form method="post" action="{% url 'update_variant' item.id %}" class="variant-form">
              {% csrf_token %}
              <select name="variant_id" class="variant-select text-sm rounded border border-gray-300 p-1" data-item-id="{{ item.id }}">
                {% for variant in item.variant.product.variants.all %}
                  <option value="{{ variant.id }}" {% if variant.id == item.variant.id %}selected{% endif %}>
                    {{ variant.color }} / {{ variant.size }}
                  </option>
                {% endfor %}
              </select>
            </form>
          </td>
          <td class="px-6 py-4 text-sm">
            {% with discount=item.variant.product.get_best_offer best_offer_obj=item.variant.product.get_best_offer_obj %}
              {% if discount and discount|floatformat:0 != '0' %}
                <p class="text-gray-400 line-through">â‚¹{{ item.variant.price|floatformat:2 }}</p>
                <p class="font-bold text-green-600 mb-0">â‚¹{{ item.variant.get_discounted_price|floatformat:2 }} <span class="bg-red-500 text-white text-xs rounded px-1">-{{ discount }}%</span></p>
                {% if best_offer_obj %}
                  <small class="text-xs text-blue-600">{{ best_offer_obj }}</small>
                {% endif %}
              {% else %}
                <p class="font-bold">â‚¹{{ item.variant.price|floatformat:2 }}</p>
              {% endif %}
            {% endwith %}
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            <div class="flex items-center space-x-2 justify-center">
              <button type="button" class="decrement-btn px-2 py-1 bg-gray-200 rounded hover:bg-gray-300" aria-label="Decrease quantity">-</button>
              <span class="quantity-text">{{ item.quantity }}</span>
              <button type="button" class="increment-btn px-2 py-1 bg-gray-200 rounded hover:bg-gray-300" aria-label="Increase quantity">+</button>
            </div>
          </td>
          <td class="px-6 py-4">
            <a href="{% url 'remove_from_cart' item.id %}" class="text-red-600 hover:underline">Remove</a>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    {% if error.cart %}
    <div class="text-red-600 text-sm">{{ error.cart }}</div>
    {% endif %}

    <div class="mt-4 text-right">
      <h4>Order Total: <span id="cart-total" data-discount="{{ discount|floatformat:2 }}" class="text-green-600 font-bold text-xl">â‚¹{{ total|floatformat:2 }}</span></h4>
    </div>

    <div class="mt-4 text-right">
      <a href="{% url 'checkout' %}" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg transition">Proceed to Checkout</a>
    </div>
    {% else %}
    <p class="text-gray-400">Your cart is empty.</p>
    {% endif %}
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
  const skeleton = document.getElementById('cart-skeleton');
  const content = document.getElementById('cart-content');

  // Show skeleton immediately
  skeleton.classList.remove('hidden');
  content.classList.add('hidden');

  // Simulate loading delay (replace with real AJAX if needed)
  setTimeout(() => {
    skeleton.classList.add('hidden');
    content.classList.remove('hidden');
  }, 800); // 0.8s delay
});

  document.addEventListener('DOMContentLoaded', () => {
    // Simulate loading time
    setTimeout(() => {
      document.getElementById('cart-skeleton').classList.add('hidden');
      document.getElementById('cart-content').classList.remove('hidden');
    }, 800); // Adjust delay as needed
  });
document.addEventListener('DOMContentLoaded', () => {
  const itemData = {};

  // Helper: Parse price from string (removes everything but digits and dot)
  function parsePrice(text) {
    if (!text) return 0;
    let clean = text.replace(/[^0-9.]/g, '');
    let val = parseFloat(clean);
    return isNaN(val) ? 0 : val;
  }

  // Cache only the true displayed price for each row (never double discount)
  document.querySelectorAll('tbody tr').forEach(row => {
    const id = row.getAttribute('data-item-id');
    let price = 0;

    // Try discounted price if present (green, font-bold), else normal price
    let priceElem = row.querySelector('td:nth-child(3) .font-bold.text-green-600') ||
                    row.querySelector('td:nth-child(3) .font-bold');
    if (priceElem) price = parsePrice(priceElem.textContent);

    let stock = 5; // Default stock; adjust if needed
    itemData[id] = { price, stock };
  });

  // For display: update per-row subtotal (for completeness, not total calculation)
  function updateItemSubtotal(row, quantity) {
    const id = row.getAttribute('data-item-id');
    const { price } = itemData[id];
    const subtotal = price * quantity;
    let subtotalCell = row.querySelector('.subtotal-text');
    if (subtotalCell) {
      subtotalCell.innerHTML = `<p class="font-bold text-green-600">â‚¹${subtotal.toFixed(2)}</p>`;
    }
  }

  // Main order total: sum products of displayed prices Ã— quantities; subtract coupon just once
  function updateOrderTotal() {
    let total = 0;
    document.querySelectorAll('tbody tr').forEach(row => {
      const quantity = parseInt(row.querySelector('.quantity-text').textContent) || 0;
      const { price } = itemData[row.getAttribute('data-item-id')];
      total += price * quantity;
    });
    const discount = parseFloat(document.getElementById('cart-total')?.dataset.discount) || 0;
    total -= discount;
    const totalElem = document.getElementById('cart-total');
    if (totalElem) totalElem.textContent = `â‚¹${total.toFixed(2)}`;
  }

  function toggleButtons(row, quantity) {
    const decBtn = row.querySelector('.decrement-btn');
    const incBtn = row.querySelector('.increment-btn');
    const id = row.getAttribute('data-item-id');
    const stock = itemData[id].stock;
    const maxQuantity = stock < 5 ? stock : 5;
    if (decBtn) decBtn.disabled = quantity <= 1;
    if (incBtn) incBtn.disabled = quantity >= maxQuantity;
  }

  async function updateBackendCartAsync(itemId, action) {
    const url = `{% url 'update_cart' 0 %}`.replace('0', itemId) + `?action=${action}`;
    try {
      await fetch(url, {
        method: 'GET',
        headers: { 'X-Requested-With': 'XMLHttpRequest' },
        credentials: 'same-origin'
      });
    } catch (error) {
      console.error('Backend update failed silently', error);
    }
  }

  function handleQuantityChangeUIOnly(button, action) {
    if (button.disabled) return;
    const row = button.closest('tr');
    const quantitySpan = row.querySelector('.quantity-text');
    const itemId = row.getAttribute('data-item-id');
    let quantity = parseInt(quantitySpan.textContent);
    const stock = itemData[itemId].stock;
    const maxQuantity = stock < 5 ? stock : 5;
    if ((action === 'increase' && quantity >= maxQuantity) || (action === 'decrease' && quantity <= 1)) return;
    quantity = action === 'increase' ? quantity + 1 : quantity - 1;
    quantitySpan.textContent = quantity;
    toggleButtons(row, quantity);
    updateItemSubtotal(row, quantity);
    updateOrderTotal();
    updateBackendCartAsync(itemId, action);
  }

  document.querySelectorAll('.increment-btn').forEach(button => {
    button.addEventListener('click', e => {
      e.preventDefault();
      handleQuantityChangeUIOnly(button, 'increase');
    });
  });
  document.querySelectorAll('.decrement-btn').forEach(button => {
    button.addEventListener('click', e => {
      e.preventDefault();
      handleQuantityChangeUIOnly(button, 'decrease');
    });
  });

  document.querySelectorAll('tbody tr').forEach(row => {
    const quantity = parseInt(row.querySelector('.quantity-text').textContent) || 0;
    toggleButtons(row, quantity);
    updateItemSubtotal(row, quantity);
  });
  updateOrderTotal();

  // Variant updates: keep using new displayed price, clear out any discounts
  document.querySelectorAll('.variant-select').forEach(select => {
    select.addEventListener('change', async e => {
      const itemId = e.target.dataset.itemId;
      const form = e.target.closest('form');
      const formData = new FormData(form);
      const row = e.target.closest('tr');
      try {
        const response = await fetch(form.action, {
          method: 'POST',
          body: formData,
          headers: { 'X-Requested-With': 'XMLHttpRequest' }
        });
        const data = await response.json();
        const priceCell = row.querySelector('td:nth-child(3)');
        const newPrice = `â‚¹${data.price.toFixed(2)}`;
        priceCell.innerHTML = `<p class="font-bold text-green-600">${newPrice}</p>`;
        itemData[itemId].price = data.price;
        itemData[itemId].stock = data.stock;
        // Remove any per-item discount (price is now always net price)
        const quantity = parseInt(row.querySelector('.quantity-text').textContent) || 0;
        updateItemSubtotal(row, quantity);
        updateOrderTotal();
      } catch (error) {
        console.error('Error updating variant:', error);
      }
    });
  });

});
</script>


{% endblock %}
