{% extends 'user/base.html' %}
{% load static %}
{% block title %} Edit Profile | GearUp {% endblock title %}

{% block content %}
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://unpkg.com/cropperjs/dist/cropper.min.css"/>
<script src="https://unpkg.com/cropperjs/dist/cropper.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
    .btn-primary {
        background: linear-gradient(135deg, #10b981 0%, #047857 100%);
        transition: all 0.3s ease;
    }
    
    .btn-primary:hover {
        background: linear-gradient(135deg, #047857 0%, #065f46 100%);
        transform: translateY(-2px);
    }
    
    .skeleton {
        background: linear-gradient(90deg, #d1fae5 25%, #a7f3d0 50%, #d1fae5 75%);
        background-size: 200% 100%;
        animation: loading 1.5s infinite;
    }
    
    @keyframes loading {
        0% {
            background-position: 200% 0;
        }
        100% {
            background-position: -200% 0;
        }
    }
    
    .profile-image-container {
        transition: all 0.3s ease;
    }
    
    .profile-image-container:hover {
        transform: scale(1.02);
    }
</style>

<div class="min-h-screen bg-emerald-50 py-8">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
        
        <!-- Breadcrumb -->
        <nav class="flex mb-8" aria-label="Breadcrumb">
            <ol class="flex items-center space-x-2 text-sm">
                <li>
                    <a href="{% url 'dashboard' %}" class="text-emerald-600 hover:text-emerald-800 transition-colors">
                        <i class="fas fa-home"></i>
                    </a>
                </li>
                <li class="flex items-center">
                    <i class="fas fa-chevron-right text-emerald-400 text-xs mx-2"></i>
                    <a href="{% url 'account_info' %}" class="text-emerald-600 hover:text-emerald-800 transition-colors">Profile</a>
                </li>
                <li class="flex items-center">
                    <i class="fas fa-chevron-right text-emerald-400 text-xs mx-2"></i>
                    <span class="text-emerald-900 font-medium">Edit Profile</span>
                </li>
            </ol>
        </nav>

        <!-- Skeleton Loader -->
        <div id="skeleton-form" class="bg-white rounded-2xl shadow-sm p-8 space-y-6">
            <!-- Header Skeleton -->
            <div class="text-center mb-8 space-y-4">
                <div class="skeleton h-8 w-48 mx-auto rounded"></div>
                <div class="skeleton h-4 w-64 mx-auto rounded"></div>
            </div>
            
            <!-- Form Fields Skeleton -->
            {% for _ in "123" %}
            <div class="space-y-2">
                <div class="skeleton h-4 w-20 rounded"></div>
                <div class="skeleton h-12 rounded-xl"></div>
            </div>
            {% endfor %}
            
            <!-- Password Section Skeleton -->
            <div class="bg-emerald-50 rounded-xl p-6 space-y-4">
                <div class="skeleton h-6 w-40 rounded"></div>
                {% for _ in "123" %}
                <div class="space-y-2">
                    <div class="skeleton h-4 w-32 rounded"></div>
                    <div class="skeleton h-12 rounded-xl"></div>
                </div>
                {% endfor %}
            </div>
            
            <!-- Profile Image Skeleton -->
            <div class="space-y-2">
                <div class="skeleton h-4 w-28 rounded"></div>
                <div class="skeleton h-12 rounded-xl"></div>
                <div class="skeleton w-40 h-40 rounded-xl mx-auto"></div>
            </div>
            
            <!-- Submit Button Skeleton -->
            <div class="skeleton h-14 rounded-xl"></div>
        </div>

        <!-- Real Form -->
        <div id="real-form" class="hidden">
            <div class="bg-white rounded-2xl shadow-sm overflow-hidden border border-emerald-100">
                <!-- Header -->
                <div class="bg-gradient-to-r from-emerald-600 to-emerald-800 px-8 py-6">
                    <div class="flex items-center gap-4">
                        <div class="bg-white bg-opacity-20 p-3 rounded-full">
                            <i class="fas fa-user-edit text-white text-xl"></i>
                        </div>
                        <div>
                            <h1 class="text-2xl font-bold text-emerald-600">Edit Profile</h1>
                            <p class="text-emerald-300 mt-1">Update your personal information and profile settings</p>
                        </div>
                    </div>
                </div>

                <!-- Form Content -->
                <div class="p-8">
                    <form method="post" enctype="multipart/form-data" novalidate class="space-y-6">
                        {% csrf_token %}

                        <!-- Personal Information Section -->
                        <div class="space-y-4">
                            <h3 class="text-lg font-semibold text-emerald-900 flex items-center gap-2 mb-4">
                                <i class="fas fa-user-circle text-emerald-600"></i>
                                Personal Information
                            </h3>
                            
                            <!-- Name -->
                            <div>
                                <label class="block text-sm font-semibold text-emerald-900 mb-2 flex items-center gap-2">
                                    <i class="fas fa-signature text-emerald-600"></i>
                                    Full Name
                                </label>
                                <input type="text" name="name" value="{{ name }}" required
                                       class="w-full border-2 border-emerald-200 rounded-xl px-4 py-3 focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition-all placeholder-emerald-400"
                                       placeholder="Enter your full name">
                                {% if error.name %}
                                <div class="flex items-center gap-2 text-red-500 text-sm mt-2">
                                    <i class="fas fa-exclamation-circle"></i>
                                    {{ error.name }}
                                </div>
                                {% endif %}
                            </div>

                            <!-- Email -->
                            {% if has_password %}
                            <div>
                                <label class="block text-sm font-semibold text-emerald-900 mb-2 flex items-center gap-2">
                                    <i class="fas fa-envelope text-emerald-600"></i>
                                    Email Address
                                </label>
                                <input type="email" name="email" value="{{ email }}" required
                                       class="w-full border-2 border-emerald-200 rounded-xl px-4 py-3 focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition-all placeholder-emerald-400"
                                       placeholder="Enter your email address">
                                {% if error.email %}
                                <div class="flex items-center gap-2 text-red-500 text-sm mt-2">
                                    <i class="fas fa-exclamation-circle"></i>
                                    {{ error.email }}
                                </div>
                                {% endif %}
                            </div>
                            {% endif %}
                        </div>

                        <!-- Change Password Section -->
                        {% if has_password %}
                        <div class="bg-emerald-50 rounded-2xl p-6 space-y-4 border border-emerald-200">
                            <h3 class="text-lg font-semibold text-emerald-900 flex items-center gap-2 mb-4">
                                <i class="fas fa-lock text-emerald-600"></i>
                                Change Password
                            </h3>

                            <div>
                                <label class="block text-sm font-semibold text-emerald-900 mb-2">Current Password</label>
                                <input type="password" name="current_password" 
                                       class="w-full border-2 border-emerald-200 rounded-xl px-4 py-3 focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition-all placeholder-emerald-400"
                                       placeholder="Enter current password">
                                {% if error.cupassword %}
                                <div class="flex items-center gap-2 text-red-500 text-sm mt-2">
                                    <i class="fas fa-exclamation-circle"></i>
                                    {{ error.cupassword }}
                                </div>
                                {% endif %}
                            </div>
                            
                            <div>
                                <label class="block text-sm font-semibold text-emerald-900 mb-2">New Password</label>
                                <input type="password" name="new_password" 
                                       class="w-full border-2 border-emerald-200 rounded-xl px-4 py-3 focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition-all placeholder-emerald-400"
                                       placeholder="Enter new password">
                                {% if error.password %}
                                <div class="flex items-center gap-2 text-red-500 text-sm mt-2">
                                    <i class="fas fa-exclamation-circle"></i>
                                    {{ error.password }}
                                </div>
                                {% endif %}
                            </div>
                            
                            <div>
                                <label class="block text-sm font-semibold text-emerald-900 mb-2">Confirm New Password</label>
                                <input type="password" name="confirm_password" 
                                       class="w-full border-2 border-emerald-200 rounded-xl px-4 py-3 focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition-all placeholder-emerald-400"
                                       placeholder="Confirm new password">
                                {% if error.cpassword %}
                                <div class="flex items-center gap-2 text-red-500 text-sm mt-2">
                                    <i class="fas fa-exclamation-circle"></i>
                                    {{ error.cpassword }}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endif %}

                        <!-- Profile Image Section -->
                        <div class="space-y-4">
                            <h3 class="text-lg font-semibold text-emerald-900 flex items-center gap-2 mb-4">
                                <i class="fas fa-camera text-emerald-600"></i>
                                Profile Image
                            </h3>
                            
                            <div class="bg-emerald-50 rounded-2xl p-6 border border-emerald-200">
                                <label class="block text-sm font-semibold text-emerald-900 mb-4">Upload New Image</label>
                                <input type="file" name="profile_image" id="profile_image"
                                       class="w-full border-2 border-emerald-200 rounded-xl px-4 py-3 focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition-all file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-emerald-500 file:text-white hover:file:bg-emerald-600">
                                
                                <!-- Image Preview -->
                                <div id="image-preview-container" class="mt-6 text-center hidden">
                                    <p class="text-sm text-emerald-700 mb-4">Crop your image (1:1 ratio recommended)</p>
                                    <img id="image-preview" class="rounded-2xl shadow-md profile-image-container max-w-xs mx-auto">
                                </div>
                                
                                {% if error.profile_image %}
                                <div class="flex items-center gap-2 text-red-500 text-sm mt-2">
                                    <i class="fas fa-exclamation-circle"></i>
                                    {{ error.profile_image }}
                                </div>
                                {% endif %}
                                <p id="image-error" class="text-red-500 text-sm mt-2"></p>
                            </div>
                        </div>

                        <!-- Submit Button -->
                        <div class="pt-6 border-t border-emerald-200">
                            <button type="submit"
                                    class="btn-primary w-full text-white py-4 rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 font-semibold text-lg flex items-center justify-center gap-2">
                                <i class="fas fa-save"></i>
                                Update Profile
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Help Section -->
            <div class="mt-8 bg-white rounded-2xl shadow-sm p-6 border border-emerald-100">
                <h3 class="text-lg font-semibold text-emerald-900 mb-4 flex items-center gap-2">
                    <i class="fas fa-info-circle text-emerald-600"></i>
                    Profile Tips
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                    <div class="flex items-start gap-3">
                        <i class="fas fa-image text-emerald-500 mt-1"></i>
                        <div>
                            <p class="font-medium text-emerald-900">Profile Image</p>
                            <p class="text-emerald-600 mt-1">Use a clear, recent photo for better recognition</p>
                        </div>
                    </div>
                    <div class="flex items-start gap-3">
                        <i class="fas fa-shield-alt text-emerald-500 mt-1"></i>
                        <div>
                            <p class="font-medium text-emerald-900">Security</p>
                            <p class="text-emerald-600 mt-1">Keep your password strong and unique</p>
                        </div>
                    </div>
                    <div class="flex items-start gap-3">
                        <i class="fas fa-sync-alt text-emerald-500 mt-1"></i>
                        <div>
                            <p class="font-medium text-emerald-900">Updates</p>
                            <p class="text-emerald-600 mt-1">Keep your information current for better service</p>
                        </div>
                    </div>
                    <div class="flex items-start gap-3">
                        <i class="fas fa-crop-alt text-emerald-500 mt-1"></i>
                        <div>
                            <p class="font-medium text-emerald-900">Image Cropping</p>
                            <p class="text-emerald-600 mt-1">Crop your image to focus on your face</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- CropperJS Script -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Show real form after loading
    setTimeout(() => {
        document.getElementById('skeleton-form').style.display = 'none';
        document.getElementById('real-form').classList.remove('hidden');
    }, 1200);

    const input = document.getElementById('profile_image');
    const image = document.getElementById('image-preview');
    const imageContainer = document.getElementById('image-preview-container');
    let cropper;
    const errorMsg = document.getElementById('image-error');

    if(input){
        input.addEventListener('change', (e)=>{
            const file = e.target.files[0];
            if(file){
                if(!file.type.startsWith('image/')){
                    errorMsg.textContent = 'Please select a valid image file.';
                    imageContainer.classList.add('hidden');
                    if(cropper) cropper.destroy();
                    return;
                }
                errorMsg.textContent = '';
                const url = URL.createObjectURL(file);
                image.src = url;
                imageContainer.classList.remove('hidden');
                if(cropper) cropper.destroy();
                cropper = new Cropper(image, {
                    aspectRatio: 1,
                    viewMode: 1,
                    autoCropArea: 1,
                    responsive: true,
                    restore: false,
                    guides: true,
                    center: true,
                    highlight: false,
                    cropBoxMovable: true,
                    cropBoxResizable: true
                });
            }
        });

        document.querySelector('form').addEventListener('submit', function(e){
            if(cropper){
                e.preventDefault();
                cropper.getCroppedCanvas().toBlob(function(blob){
                    const file = new File([blob],'cropped_profile_image.png',{type:'image/png'});
                    const dt = new DataTransfer();
                    dt.items.add(file);
                    input.files = dt.files;
                    e.target.submit();
                },'image/png');
            }
        });
    }

    // Add focus effects to form inputs
    const inputs = document.querySelectorAll('input');
    inputs.forEach(input => {
        input.addEventListener('focus', function() {
            this.classList.add('ring-2', 'ring-emerald-200');
        });
        input.addEventListener('blur', function() {
            this.classList.remove('ring-2', 'ring-emerald-200');
        });
    });
});
</script>
{% endblock content %}