{% extends 'user/base.html' %}

{% block content %}
<style>
body { background-color: #BAA991; }

input, textarea, select {
    width: 100%;
    padding: 0.375rem 0.75rem;
    font-size: 1rem;
    line-height: 1.5;
    color: #212529;
    background-color: #fff;
    border: 1.5px solid #ced4da;
    border-radius: 0.5rem;
}

input:focus, textarea:focus, select:focus {
    border-color: #0d6efd;
    outline: 0;
    box-shadow: 0 0 8px rgba(13, 110, 253, 0.3);
}

.account-container { max-width: 850px; margin:auto; padding:2rem 1rem; }
.account-card { background:#fff; border-radius:12px; box-shadow:0 4px 15px rgba(0,0,0,0.1); padding:2.5rem; }
.change-password-section { background:#f8f9fa; border-radius:10px; padding:1.5rem 2rem; margin-top:2rem; border:1px solid #ddd; }
.change-password-section h3 { border-bottom:2px solid #0d6efd; padding-bottom:0.3rem; margin-bottom:1.25rem; color:#495057; font-weight:600; }
.form-label { font-weight:600; color:#555; }
.text-danger { font-size:0.9rem; margin-top:0.25rem; }
button.btn-primary { background-color:#0d6efd; border-color:#0d6efd; transition:0.3s; }
button.btn-primary:hover { background-color:#0b5ed7; border-color:#0a58ca; }
</style>

<div class="container account-container">
  <div class="card account-card">
    <h2 class="text-center mb-4">Edit Profile</h2>
    <form method="post" enctype="multipart/form-data" novalidate>
      {% csrf_token %}

      <!-- Name -->
      <div class="mb-3">
        <label class="form-label">Name</label>
        <input type="text" name="name" value="{{ name }}" required>
        {% if error.name %}<div class="text-danger">{{ error.name }}</div>{% endif %}
      </div>

      <!-- Email (only if user has password) -->
      {% if has_password %}
      <div class="mb-3">
        <label class="form-label">Email</label>
        <input type="email" name="email" value="{{ email }}" required>
        {% if error.email %}<div class="text-danger">{{ error.email }}</div>{% endif %}
      </div>
      {% endif %}

      <!-- Change Password -->
      {% if has_password %}
      <div class="change-password-section">
        <h3>Change Password</h3>
        <div class="mb-3">
          <label class="form-label">Current Password</label>
          <input type="password" name="current_password">
          {% if error.cupassword %}<div class="text-danger">{{ error.cupassword }}</div>{% endif %}
        </div>
        <div class="mb-3">
          <label class="form-label">New Password</label>
          <input type="password" name="new_password">
          {% if error.password %}<div class="text-danger">{{ error.password }}</div>{% endif %}
        </div>
        <div class="mb-3">
          <label class="form-label">Confirm New Password</label>
          <input type="password" name="confirm_password">
          {% if error.cpassword %}<div class="text-danger">{{ error.cpassword }}</div>{% endif %}
        </div>
      </div>
      {% endif %}

      <!-- Profile Image -->
      <div class="mb-3">
        <label class="form-label">Profile Image</label>
        <input type="file" name="profile_image" id="profile_image">
        <img id="image-preview" style="display:none; max-width:100%; margin-top:1rem;">
        {% if error.profile_image %}<div class="text-danger">{{ error.profile_image }}</div>{% endif %}
      </div>

      <!-- Submit -->
      <div class="text-center mt-4">
        <button type="submit" class="btn btn-primary">Update Profile</button>
      </div>
    </form>
  </div>
</div>

<script src="https://unpkg.com/cropperjs/dist/cropper.min.js"></script>
<link rel="stylesheet" href="https://unpkg.com/cropperjs/dist/cropper.min.css"/>

<script>
const input = document.getElementById('profile_image');
const image = document.getElementById('image-preview');
let cropper;

if(input){
  input.addEventListener('change', (e)=>{
    const file = e.target.files[0];
    if(file){
      const url = URL.createObjectURL(file);
      image.src = url;
      image.style.display = 'block';
      if(cropper) cropper.destroy();
      cropper = new Cropper(image, {aspectRatio:1, viewMode:1, autoCropArea:1});
    }
  });

  document.querySelector('form').addEventListener('submit', function(e){
    if(cropper){
      e.preventDefault();
      cropper.getCroppedCanvas().toBlob(function(blob){
        const file = new File([blob],'cropped_profile_image.png',{type:'image/png'});
        const dt = new DataTransfer();
        dt.items.add(file);
        input.files = dt.files;
        e.target.submit();
      },'image/png');
    }
  });
}
</script>
{% endblock content %}
