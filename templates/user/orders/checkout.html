{% extends "user/base.html" %}
{% block title %} Checkout {% endblock title %}
{% block content %}

<!-- Tailwind Skeleton Styles -->
<style>
  .skeleton-bg {
    background-color: #e2e2e2;
    border-radius: 6px;
    animation: skeleton-loading 1.2s infinite linear;
  }
  .skeleton-line {
    height: 20px;
    margin: 12px 0;
    border-radius: 6px;
  }
  .skeleton-btn {
    height: 40px;
    width: 150px;
    margin-top: 15px;
  }
  .skeleton-radio {
    height: 20px;
    width: 120px;
    margin: 8px 0;
  }
  .skeleton-list-item {
    margin-bottom: 12px;
    height: 25px;
    width: 100%;
  }
  @keyframes skeleton-loading {
    0% { opacity: 1; }
    50% { opacity: 0.4; }
    100% { opacity: 1; }
  }
</style>

<div class="max-w-2xl mx-auto my-8 px-4">
  <h2 class="text-2xl font-bold mb-4">Checkout</h2>
  <hr class="mb-8">

  <!-- Skeleton loading placeholders -->
  <div id="skeleton-checkout" class="block">
    <h5 class="skeleton-bg skeleton-line" style="width: 180px;"></h5>
    {% for _ in "1234" %}
      <div class="skeleton-bg skeleton-list-item"></div>
    {% endfor %}
    <div class="skeleton-bg skeleton-btn"></div>

    <h5 class="mt-4 skeleton-bg skeleton-line" style="width: 140px;"></h5>
    <div class="skeleton-bg skeleton-radio"></div>
    <div class="skeleton-bg skeleton-radio"></div>
    <div class="skeleton-bg skeleton-radio"></div>

    <h5 class="mt-4 skeleton-bg skeleton-line" style="width: 130px;"></h5>
    {% for _ in "12345" %}
      <div class="skeleton-bg skeleton-list-item"></div>
    {% endfor %}
    <div class="skeleton-bg skeleton-btn" style="width: 180px;"></div>
  </div>

  <!-- Real checkout form (hidden initially) -->
  <div id="real-checkout-form" class="hidden">
    <form method="post" class="space-y-6">
      {% csrf_token %}

      <!-- Shipping Address -->
      <div>
        <h5 class="text-lg font-semibold mb-2">Shipping Address</h5>
        <div class="flex flex-col gap-4 mb-3">
          {% for addr in addresses %}
          <div class="rounded-lg p-4 border {{ addr.is_default|yesno:'border-green-500 shadow-md,border-gray-200' }} bg-white">
            <div class="flex flex-col md:flex-row md:justify-between md:items-center">
              <label class="flex items-center w-full">
                <input type="radio" name="address" value="{{ addr.id }}"
                  {% if addr.is_default %}checked{% elif forloop.first %}checked{% endif %}
                  class="mr-2 h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500" />
                <div>
                  <span class="block font-medium">{{ addr.full_name }}</span>
                  <span class="block text-gray-500 text-sm">{{ addr.full_address }}</span>
                </div>
              </label>
              {% if addr.is_default %}
                <span class="inline-flex items-center gap-1 px-3 py-1 rounded bg-green-500 text-white text-xs ml-3 mt-2 md:mt-0">
                  <svg class="w-4 h-4 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927C11.469 2.04 12.531 2.04 12.951 2.927L15.442 8.684C15.597 9.021 15.915 9.25 16.284 9.25H22.25C23.216 9.25 23.616 10.409 22.861 10.947L17.719 14.662C17.436 14.867 17.312 15.236 17.453 15.555L19.944 21.312C20.364 22.199 19.344 22.989 18.59 22.451L13.448 18.736C13.164 18.531 12.837 18.531 12.553 18.736L7.411 22.452C6.656 22.991 5.636 22.201 6.056 21.314L8.547 15.557C8.688 15.238 8.563 14.869 8.28 14.664L3.138 10.949C2.382 10.41 2.783 9.251 3.749 9.251H9.716C10.085 9.251 10.403 9.022 10.558 8.686L13.049 2.929z"/>
                  </svg>
                  Default
                </span>
              {% endif %}
            </div>
            <div class="flex gap-2 justify-end mt-2 pt-2 border-t border-gray-100">
              <a href="{% url 'edit_address' addr.id %}?next={{ request.path }}"
                 class="text-blue-600 hover:underline text-sm">Edit</a>
              {% if not addr.is_default %}
                <a href="{% url 'delete_address' addr.pk %}"
                   class="text-red-600 hover:underline text-sm"
                   onclick="return confirm('Are you sure you want to delete this address?');">Delete</a>
              {% endif %}
            </div>
          </div>
          {% empty %}
          <p class="text-red-600 font-semibold">No addresses found. Please add one.</p>
          {% endfor %}
        </div>
        <a href="{% url 'add_address' %}?next={{ request.path }}"
           class="inline-block bg-green-600 text-white px-3 py-1 rounded hover:bg-green-700 text-sm mb-3">
          + Add New Address
        </a>
      </div>

      <!-- Payment Method -->
      <div>
        <h5 class="text-lg font-semibold mb-2">Payment Method</h5>
        <div class="space-y-2">
          <label class="flex items-center bg-white p-3 border border-gray-200 rounded">
            <input type="radio" name="payment_method" value="COD"
                   {% if total > 1000 %}disabled{% else %}checked{% endif %}
                   class="mr-2 h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500">
            <span>Cash on Delivery
              {% if total > 1000 %}
                <span class="text-red-600 text-xs ml-2">(COD not available for orders above ₹1000)</span>
              {% endif %}
            </span>
          </label>
          <label class="flex items-center bg-white p-3 border border-gray-200 rounded">
            <input type="radio" name="payment_method" value="ONLINE"
                   {% if grand_total > 1000 %}checked{% endif %}
                   class="mr-2 h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500">
            <span>Pay Online (Razorpay)</span>
          </label>
          <label class="flex items-center bg-white p-3 border border-gray-200 rounded">
            <input type="radio" name="payment_method" value="WALLET"
                   class="mr-2 h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500">
            <span>
              Pay with Wallet (Balance: ₹{{ wallet.balance }})
              {% if error.wallet %}
                <span class="text-red-600 text-xs ml-2">{{ error.wallet }}</span>
              {% endif %}
            </span>
          </label>
        </div>
      </div>

      <!-- Order Summary -->
      <div>
        <h5 class="text-lg font-semibold mb-2">Order Summary</h5>
        <ul class="divide-y divide-gray-200 bg-white rounded shadow">
          {% for item in cart_items %}
            <li class="flex justify-between items-center p-2">
              <span>
                {{ item.variant.product.name }} ({{ item.variant.color }}/{{ item.variant.size }}) x{{ item.quantity }}
                {% if item.variant.product.get_best_offer > 0 %}
                  <br>
                  <span class="text-green-700 text-xs">Offer: {{ item.variant.product.get_best_offer }}% Off</span>
                {% endif %}
              </span>
              <span class="font-semibold text-green-700">₹{{ item.subtotal }}</span>
            </li>
          {% endfor %}
        </ul>
        {% if coupon %}
          <div class="my-3 p-2 bg-blue-50 border-l-4 border-blue-400 rounded text-blue-900">
            <strong>Coupon "{{ coupon.code }}" Applied:</strong>
            <span class="text-green-700">-₹{{ discount }}</span>
          </div>
        {% endif %}
        <div class="flex justify-between my-1 text-gray-700">
          <span>Delivery Charges:</span>
          <span>₹{{ delivery_charge }}</span>
        </div>
        <div class="flex justify-between my-1 text-gray-700">
          <span>Tax:</span>
          <span>₹{{ tax }}</span>
        </div>
        <div class="flex justify-between my-1 text-lg font-bold">
          <span>Total to Pay:</span>
          <span>₹{{ grand_total }}</span>
        </div>
      </div>

      <button type="submit"
        class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg shadow mt-4 transition">
        Place Order
      </button>
    </form>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const skeleton = document.getElementById('skeleton-checkout');
    const realForm = document.getElementById('real-checkout-form');
    skeleton.classList.remove('hidden');
    realForm.classList.add('hidden');
    setTimeout(() => {
      skeleton.classList.add('hidden');
      realForm.classList.remove('hidden');
    }, 1000);
  });
</script>
{% endblock %}
