{% extends "user/base.html" %}
{% load static %}
{% block content %}
<div class="container my-5">

    <!-- Order Header -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2>Order #{{ order.order_code }}</h2>
    </div>
    <p class="text-muted">Placed on: {{ order.created_at|date:"M d, Y H:i" }}</p>
    <p><strong>Payment Method:</strong> {{ order.payment_method }} {% if order.payment_status == "Failed" %} (Failed) {% endif %}</p>
    <a href="{% url 'download_invoice' order.order_code %}" class="btn btn-sm btn-outline-dark">
        <i class="bi bi-download"></i> Download Invoice
    </a>
{% if order.payment_status == "Failed" %}
<div class="card border-0 shadow-sm rounded-3 my-4 bg-light">
    <div class="card-body d-flex align-items-center justify-content-between">
        
        <!-- Left side -->
        <div class="d-flex align-items-center">
            <div class="bg-danger text-white rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 40px; height: 40px;">
                <i class="bi bi-x-lg"></i>
            </div>
            <div>
                <h6 class="mb-0 text-danger">Payment Failed</h6>
                <small class="text-muted">Your transaction could not be completed.</small>
            </div>
        </div>

        <!-- Right side (Retry Button) -->
        <a href="{% url 'retry_payment' order.order_id %}" class="btn btn-danger btn-sm">
            <i class="bi bi-arrow-repeat"></i> Retry Payment
        </a>
    </div>
</div>
{% endif %}


    <!-- Shipping Address -->
<h5 class="mt-4">Shipping Address</h5>
<div class="border rounded p-3 mb-4 shadow-sm">
    {% if order.address %}
        <p class="mb-1"><strong>{{ order.address.full_name }}</strong></p>
        <p class="mb-1">{{ order.address.address_line_1 }}</p>
        {% if order.address.address_line_2 %}
            <p class="mb-1">{{ order.address.address_line_2 }}</p>
        {% endif %}
        <p class="mb-1">{{ order.address.city }}, {{ order.address.state }} - {{ order.address.postal_code }}</p>
        <p class="mb-1">{{ order.address.country }}</p>
        <p class="mb-0"><strong>Phone:</strong> {{ order.address.phone }}</p>
    {% else %}
        <p class="text-muted">No address available</p>
    {% endif %}
</div>
    <hr>

    <!-- Order Items -->
    <h5 class="mt-4 mb-3">Items</h5>
    <ul class="list-group mb-4 shadow-sm">
        {% for item in items %}
        <li class="list-group-item d-flex justify-content-between align-items-center">

            <!-- Product Info -->
            <div class="d-flex align-items-center">
                {% if item.variant.product.image %}
                    <img src="{{ item.variant.product.image.url }}" 
                         alt="{{ item.variant.product.name }}" 
                         class="img-thumbnail me-3" 
                         style="width: 80px; height: 80px; object-fit: cover;">
                {% else %}
                    <img src="{% static 'images/placeholder.png' %}" 
                         alt="No image" 
                         class="img-thumbnail me-3" 
                         style="width: 80px; height: 80px; object-fit: cover;">
                {% endif %}
                <div>
                    <strong>{{ item.variant.product.name }}</strong><br>
                    <small class="text-muted">
                        {% if item.variant.color %}Color: {{ item.variant.color }}{% endif %}
                        {% if item.variant.size %} / Size: {{ item.variant.size }}{% endif %}
                    </small><br>
                    <small>Qty: {{ item.quantity }}</small>
                </div>
            </div>

            <!-- Subtotal & Status -->
            <div class="text-end">
                <div class="fw-bold mb-1">₹{{ item.subtotal }}</div>

                {# --- Cancellation Flow --- #}
                <!-- Cancellation Button / Status -->
<!-- Cancellation Section -->
<!-- Cancellation Section -->
{% if item.status == "pending" or item.status == "shipped" %}
    {% if not item.cancellation_requested %}
        <span class="badge 
          {% if item.status == 'pending' %}bg-warning
          {% elif item.status == 'shipped' %}bg-info
          {% else %}bg-secondary
          {% endif %}
        ">
          {{ item.status | title}}
        </span>
        <a href="{% url 'cancel_order_item_page' item.item_id %}" 
           class="btn btn-sm btn-danger mt-2">
            Request Cancellation
        </a>

    {% else %}
        {% if item.cancellation_approved is none %}
            <span class="badge bg-warning text-dark">Cancellation Pending</span>
            <small class="d-block text-muted">Reason: {{ item.cancellation_reason }}</small>
        {% elif item.cancellation_approved == False %}
                <span class="badge bg-secondary">Cancellation Rejected</span>
                <small class="d-block text-muted">Reason: {{ item.cancellation_reason }}</small>
        {% else%}
                <h1>Hello</h1>
        {% endif %}
    {% endif %}
{% endif %}

{% if item.status == "cancelled" %}
            <span class="badge bg-danger">Cancelled</span>
{% endif %}



{% if item.status|lower == "delivered" %}
    {% if not item.return_requested %}
    <span class="badge bg-success">{{item.status}}</span>
        <a href="{% url 'return_order_item_page' item.item_id %}" 
           class="btn btn-sm btn-dark mt-2">
            Request Return
        </a>

    {% else %}
        {% if item.return_approved is none %}
            <span class="badge bg-info text-dark">Return Pending</span>
            <small class="d-block text-muted">Reason: {{ item.return_reason }}</small>

        {% elif item.return_approved %}
            <span class="badge bg-success">Returned</span>

        {% elif item.return_approved == False %}
            <span class="badge bg-danger">Return Rejected</span>
            <small class="d-block text-danger">Reason: {{ item.return_reason }}</small>
        {% endif %}
    {% endif %}
{% endif %}


            </div>

        </li>
        {% endfor %}
    </ul>

    <!-- Order Total -->
    <div class="text-end">
        <h4>Total: ₹{{ order.total_price }}</h4>
    </div>

    

</div>
{% endblock %}
