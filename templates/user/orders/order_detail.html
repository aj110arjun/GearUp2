{% extends "user/base.html" %}
{% load custom_filters %}
{% block title %}Order Details{% endblock title %}
{% block content %}
<style>
  /* Skeleton Loading Styles */
  .skeleton-bg {
    @apply bg-gray-300 rounded animate-pulse;
  }
  .skeleton-line {
    @apply h-5 my-2 rounded;
  }
  .skeleton-img {
    @apply w-12 h-12 rounded;
  }
  .skeleton-badge {
    @apply w-20 h-5 rounded-full;
  }
</style>

<div class="max-w-7xl mx-auto p-4 select-none">

  <!-- Skeleton order detail -->
  <div id="skeleton-order-detail" class="block space-y-6">
    <div class="space-y-2">
      <div class="skeleton-bg skeleton-line w-72 h-8"></div>
      <div class="skeleton-bg skeleton-line w-48 h-5"></div>
    </div>

    <div class="flex flex-col md:flex-row md:space-x-6">
      <div class="md:flex-1 bg-white p-4 rounded-md shadow">
        <div class="skeleton-bg skeleton-line w-36 h-6 mb-6"></div>
        <table class="w-full table-fixed border-collapse">
          <thead>
            <tr>
              {% for _ in "1234567" %}
              <th><div class="skeleton-bg skeleton-line w-20 h-4"></div></th>
              {% endfor %}
            </tr>
          </thead>
          <tbody>
            {% for _ in "1234" %}
            <tr class="h-10">
              <td><div class="skeleton-bg skeleton-img"></div></td>
              <td><div class="skeleton-bg skeleton-line w-32"></div></td>
              <td><div class="skeleton-bg skeleton-line w-12"></div></td>
              <td><div class="skeleton-bg skeleton-line w-6"></div></td>
              <td><div class="skeleton-bg skeleton-line w-12"></div></td>
              <td><div class="skeleton-bg skeleton-badge"></div></td>
              <td><div class="skeleton-bg skeleton-line w-20"></div></td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Real order detail -->
  <div id="real-order-detail" class="hidden">

    <div class="space-y-6">
      <!-- Header -->
      <div>
        <h2 class="text-2xl font-bold">
          Order Details <span class="text-blue-600">#{{ order.order_code }}</span>
        </h2>
        <p class="text-gray-600">Placed on: {{ order.created_at|date:"d M Y, H:i" }}</p>
      </div>

      <div class="flex flex-col md:flex-row md:space-x-6">
        
        <!-- Left Section: Order Items -->
        <div class="md:flex-1 bg-white rounded-md shadow p-5">
          <div class="flex justify-between items-center mb-6 border-b pb-3">
            <h3 class="text-lg font-semibold">Items in Your Order</h3>
            <a href="{% url 'download_invoice' order.order_code %}"
              class="text-green-600 border border-green-600 px-3 py-1 rounded hover:bg-green-600 hover:text-white transition">
              <i class="bi bi-file-earmark-arrow-down"></i> Invoice
            </a>
          </div>

          <div class="overflow-x-auto">
            <table class="w-full text-sm border-collapse">
              <thead class="bg-gray-100 text-gray-700">
                <tr>
                  <th class="p-3 text-left border">Product</th>
                  <th class="p-3 text-left border">Variant</th>
                  <th class="p-3 text-center border">Price</th>
                  <th class="p-3 text-center border">Qty</th>
                  <th class="p-3 text-center border">Tax</th>
                  <th class="p-3 text-center border">Status</th>
                  <th class="p-3 text-center border">Action</th>
                </tr>
              </thead>
              <tbody class="text-gray-800">
                {% for item in items %}
                <tr class="border-b hover:bg-gray-50 transition">
                  <td class="p-3 flex items-center gap-3">
                    {% if item.variant.product.image %}
                    <img src="{{ item.variant.product.image.url }}" alt="{{ item.variant.product.name }}"
                      class="w-12 h-12 rounded object-cover border" />
                    {% endif %}
                    <span class="font-medium">{{ item.variant.product.name }}</span>
                  </td>
                  <td class="p-3">{{ item.variant.color }} - {{ item.variant.size }}</td>
                  <td class="p-3 text-center">₹{{ item.price }}</td>
                  <td class="p-3 text-center">{{ item.quantity }}</td>
                  <td class="p-3 text-center">₹{{ item.tax }}</td>

                  <td class="p-3 text-center">
                    {% if item.status == 'delivered' %}
                      <span class="px-2 py-1 rounded text-xs text-white bg-green-600">{{ item.status|title }}</span>
                    {% elif item.status == 'shipped' %}
                      <span class="px-2 py-1 rounded text-xs text-white bg-blue-600">{{ item.status|title }}</span>
                    {% elif item.status == 'pending' %}
                      <span class="px-2 py-1 rounded text-xs text-gray-800 bg-yellow-400">{{ item.status|title }}</span>
                    {% elif item.status == 'cancelled' %}
                      <span class="px-2 py-1 rounded text-xs text-white bg-red-600">{{ item.status|title }}</span>
                    {% else %}
                      <span class="px-2 py-1 rounded text-xs text-white bg-gray-500">{{ item.status|title }}</span>
                    {% endif %}
                  </td>

                  <td class="p-3 text-center">
                    {% if item.status == "delivered" and not item.return_requested %}
                      <a href="{% url 'return_order_item_page' item.item_id %}"
                        class="bg-gray-700 hover:bg-gray-800 text-white rounded px-2 py-1 text-xs">
                        Return
                      </a>
                    {% elif item.status == "pending" or item.status == "shipped" %}
                      {% if item.cancellation_requested %}
                        <span class="text-gray-500 text-sm">Cancel Requested</span>
                      {% else %}
                        <a href="{% url 'cancel_order_item_page' item.item_id %}"
                          class="bg-red-600 hover:bg-red-700 text-white rounded px-2 py-1 text-xs">
                          Cancel
                        </a>
                      {% endif %}
                    {% else %}
                      <span class="text-gray-500 text-sm">N/A</span>
                    {% endif %}
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>

        <!-- Right Section: Summary, Address, Payment -->
        <div class="md:w-1/3 space-y-6 mt-6 md:mt-0">
          <!-- Summary -->
          <div class="bg-white rounded-md shadow p-5">
            <h5 class="font-semibold mb-3">Order Summary</h5>
            <ul class="text-sm space-y-2">
              <li class="flex justify-between">
                <span>Subtotal</span><span>₹{{ subtotal }}</span>
              </li>
              <li class="flex justify-between">
                <span>Total Tax</span><span>₹{{ total_tax }}</span>
              </li>
              <li class="flex justify-between">
                <span>Delivery Charge</span><span>₹{{ delivery_charge }}</span>
              </li>
              {% if order.discount %}
              <li class="flex justify-between text-green-600 font-semibold">
                <span>Discount</span><span>-₹{{ order.discount }}</span>
              </li>
              {% endif %}
              <li class="flex justify-between font-bold bg-gray-100 p-2 rounded">
                <span>Grand Total</span><span>₹{{ grand_total }}</span>
              </li>
            </ul>
          </div>

          <!-- Shipping -->
          <div class="bg-white rounded-md shadow p-5">
            <h5 class="font-semibold mb-3">Shipping Address</h5>
            <p>{{ order.address.full_name }}</p>
            <p>{{ order.address.address_line_1 }}{% if order.address.address_line_2 %}, {{ order.address.address_line_2 }}{% endif %}</p>
            <p>{{ order.address.city }}, {{ order.address.state }} - {{ order.address.postal_code }}</p>
            <p>Phone: {{ order.address.phone }}</p>
          </div>

          <!-- Payment -->
          <div class="bg-white rounded-md shadow p-5">
            <h5 class="font-semibold mb-3">Payment Information</h5>
            <p><strong>Method:</strong> {{ order.payment_method }}</p>
            <p><strong>Status:</strong> {{ order.payment_status }}</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      setTimeout(function () {
        document.getElementById("skeleton-order-detail").classList.add("hidden");
        document.getElementById("real-order-detail").classList.remove("hidden");
      }, 1000);
    });
  </script>
</div>
{% endblock %}
