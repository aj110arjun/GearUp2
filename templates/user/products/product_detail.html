{% extends "user/base.html" %}
{% load static %}

{% block title %}{{ product.name }} - GearUp{% endblock %}

{% block content %}
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

<style>
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
  }
  .fade-in { animation: fadeIn 0.6s ease-out forwards; }
  
  @keyframes shimmer {
    0% { background-position: -1000px 0; }
    100% { background-position: 1000px 0; }
  }
  .shimmer {
    background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
    background-size: 1000px 100%;
    animation: shimmer 2s infinite;
  }
  
  .image-zoom {
    transition: transform 0.3s ease;
  }
  
  .star-rating input[type="radio"]:checked ~ label {
    color: #fbbf24;
  }
  
  .star-rating label:hover,
  .star-rating label:hover ~ label {
    color: #fbbf24;
  }
  
  .badge-pulse {
    animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
  }
  
  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: .7; }
  }
</style>

<div class="min-h-screen bg-gradient-to-br from-gray-50 to-gray-100 py-8 px-4">
  <div class="max-w-7xl mx-auto">

   <!-- Breadcrumb -->
     <nav class="flex mb-8" aria-label="Breadcrumb">
      <ol class="inline-flex items-center space-x-1 md:space-x-3">
        <li class="inline-flex items-center">
          <a href="/" class="text-gray-500 hover:text-gray-900 inline-flex items-center text-sm font-medium">
            <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20"><path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"></path></svg>
            Home
          </a>
        </li>
        <li>
          <div class="flex items-center">
            <svg class="w-6 h-6 text-gray-400" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path></svg>
            <a href="{% url 'product_list' %}" class="text-gray-500 hover:text-gray-900 ml-1 text-sm font-medium">Shop</a>
          </div>
        </li>
        <li>
          <div class="flex items-center">
            <svg class="w-6 h-6 text-gray-400" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path></svg>
            <a href="#" class="text-gray-500 hover:text-gray-900 ml-1 text-sm font-medium">{{product.name}}</a>
          </div>
        </li>
      </ol>
    </nav>

    <!-- Skeleton Loader -->
    <div id="skeleton-content">
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <!-- Image Skeleton -->
        <div>
          <div class="shimmer rounded-2xl h-96 lg:h-[500px] mb-4"></div>
          <div class="flex gap-3">
            {% for i in "12345" %}
              <div class="shimmer h-20 w-20 rounded-lg"></div>
            {% endfor %}
          </div>
        </div>
        
        <!-- Info Skeleton -->
        <div class="space-y-4">
          <div class="shimmer h-10 w-4/5 rounded-lg"></div>
          <div class="shimmer h-6 w-2/5 rounded-lg"></div>
          <div class="shimmer h-32 w-full rounded-lg"></div>
          <div class="shimmer h-16 w-full rounded-lg"></div>
          <div class="space-y-3">
            {% for i in "123" %}
              <div class="shimmer h-24 w-full rounded-lg"></div>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>

    <!-- Real Content -->
    <div id="real-content" class="hidden">
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 lg:gap-12">
        
        <!-- Product Images Section -->
        <div class="fade-in">
          <div class="sticky top-4">
            <!-- Main Image -->
            <div class="relative bg-white rounded-2xl overflow-hidden shadow-2xl mb-4 group">
              <div class="aspect-square flex items-center justify-center p-8 bg-gradient-to-br from-gray-50 to-white">
                <img id="main-product-image" 
                     src="{{ product.image.url }}" 
                     alt="{{ product.name }}"
                     class="max-w-full max-h-full object-contain image-zoom cursor-zoom-in">
              </div>
              
              <!-- Wishlist Badge -->
              <div class="absolute top-4 right-4">
                {% if in_wishlist %}
                  <a href="{% url 'wishlist_view' %}" 
                     class="bg-white rounded-full p-3 shadow-lg hover:shadow-xl transition group/wish">
                    <i class="fas fa-heart text-red-500 text-xl"></i>
                  </a>
                {% else %}
                  <a href="{% url 'add_to_wishlist' product.pk %}" 
                     class="bg-white rounded-full p-3 shadow-lg hover:shadow-xl transition group/wish">
                    <i class="far fa-heart text-gray-400 group-hover/wish:text-red-500 text-xl transition"></i>
                  </a>
                {% endif %}
              </div>
              
              <!-- Zoom Hint -->
              <div class="absolute bottom-4 right-4 bg-black bg-opacity-60 text-white px-3 py-1 rounded-full text-xs opacity-0 group-hover:opacity-100 transition">
                <i class="fas fa-search-plus mr-1"></i> Hover to zoom
              </div>
            </div>

            <!-- Thumbnail Images -->
            <div class="flex gap-3 overflow-x-auto pb-2">
              <img src="{{ product.image.url }}" 
                   alt="{{ product.name }}"
                   class="thumb-img border-3 border-blue-600 rounded-xl cursor-pointer h-20 w-20 object-cover transition-all hover:shadow-lg flex-shrink-0">
              {% for img in additional_images %}
              <img src="{{ img.image.url }}" 
                   alt="{{ img.alt_text }}"
                   class="thumb-img border-3 border-gray-200 rounded-xl cursor-pointer h-20 w-20 object-cover transition-all hover:shadow-lg flex-shrink-0">
              {% endfor %}
            </div>
          </div>
        </div>

        <!-- Product Details Section -->
        <div class="fade-in space-y-6">
          
          <!-- Header -->
          <div>
            <div class="flex items-center space-x-2 mb-2">
              <span class="px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-sm font-semibold">
                <i class="fas fa-tag mr-1"></i>{{ product.brand }}
              </span>
              {% with discount=product.get_best_offer %}
                {% if discount > 0 %}
                  <span class="px-3 py-1 bg-gradient-to-r from-red-500 to-red-600 text-white rounded-full text-sm font-bold badge-pulse">
                    <i class="fas fa-fire mr-1"></i>{{ discount }}% OFF
                  </span>
                {% endif %}
              {% endwith %}
            </div>
            
            <h1 class="text-4xl font-bold text-gray-900 mb-3">{{ product.name }}</h1>
            
            <!-- Rating -->
            <div class="flex items-center space-x-4 mb-4">
              <div class="flex items-center space-x-1">
                {% for i in "12345" %}
                  {% if i|add:"0" <= product.avg_rating %}
                    <i class="fas fa-star text-yellow-400 text-lg"></i>
                  {% else %}
                    <i class="far fa-star text-gray-300 text-lg"></i>
                  {% endif %}
                {% endfor %}
                <span class="ml-2 text-gray-600 font-semibold">{{ product.avg_rating|floatformat:1 }}</span>
              </div>
              <span class="text-gray-400">|</span>
              <span class="text-gray-600">{{ product.rating_count }} Reviews</span>
            </div>
          </div>

          <!-- Description -->
          <div class="bg-gradient-to-r from-blue-50 to-purple-50 rounded-2xl p-6">
            <h3 class="text-lg font-semibold text-gray-800 mb-2 flex items-center">
              <i class="fas fa-info-circle text-blue-600 mr-2"></i>
              Product Description
            </h3>
            <p class="text-gray-700 leading-relaxed">{{ product.description }}</p>
          </div>

          <!-- Features/Highlights -->
          <div class="grid grid-cols-2 gap-4">
            <div class="bg-white rounded-xl p-4 shadow-md border-l-4 border-green-500">
              <i class="fas fa-truck text-green-600 text-2xl mb-2"></i>
              <p class="font-semibold text-gray-800">Free Delivery</p>
              <p class="text-sm text-gray-500">On orders over $50</p>
            </div>
            <div class="bg-white rounded-xl p-4 shadow-md border-l-4 border-blue-500">
              <i class="fas fa-shield-alt text-blue-600 text-2xl mb-2"></i>
              <p class="font-semibold text-gray-800">Secure Payment</p>
              <p class="text-sm text-gray-500">100% Protected</p>
            </div>
            <div class="bg-white rounded-xl p-4 shadow-md border-l-4 border-purple-500">
              <i class="fas fa-undo text-purple-600 text-2xl mb-2"></i>
              <p class="font-semibold text-gray-800">Easy Returns</p>
              <p class="text-sm text-gray-500">30-day return policy</p>
            </div>
            <div class="bg-white rounded-xl p-4 shadow-md border-l-4 border-orange-500">
              <i class="fas fa-headset text-orange-600 text-2xl mb-2"></i>
              <p class="font-semibold text-gray-800">24/7 Support</p>
              <p class="text-sm text-gray-500">Always here to help</p>
            </div>
          </div>

          <!-- Variants Section -->
          <div class="bg-white rounded-2xl p-6 shadow-xl">
            <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">
              <i class="fas fa-boxes text-purple-600 mr-3"></i>
              Available Options
            </h2>
            
            <div class="space-y-3">
              {% for v in variants %}
              <div class="group relative bg-gradient-to-br from-gray-50 to-white rounded-xl p-5 border-2 border-gray-200 hover:border-blue-500 transition-all shadow-sm hover:shadow-lg">
                <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center gap-4">
                  
                  <!-- Variant Info -->
                  <div class="flex-1">
                    <div class="flex items-center space-x-3 mb-2">
                      <span class="px-3 py-1 bg-blue-100 text-blue-700 rounded-lg text-sm font-semibold">
                        <i class="fas fa-palette mr-1"></i>{{ v.color }}
                      </span>
                      <span class="px-3 py-1 bg-purple-100 text-purple-700 rounded-lg text-sm font-semibold">
                        <i class="fas fa-ruler mr-1"></i>{{ v.size }}
                      </span>
                    </div>
                    
                    <!-- Pricing -->
                    <div class="flex items-center space-x-3">
                      {% with discount=v.product.get_best_offer %}
                        {% if discount > 0 %}
                          <span class="text-2xl font-bold text-green-600">₹{{ v.get_discounted_price }}</span>
                          <span class="text-lg text-gray-400 line-through">₹{{ v.price }}</span>
                          <span class="px-2 py-1 bg-red-500 text-white rounded-md text-xs font-bold">
                            SAVE {{ discount }}%
                          </span>
                        {% else %}
                          <span class="text-2xl font-bold text-gray-800">₹{{ v.price }}</span>
                        {% endif %}
                      {% endwith %}
                    </div>
                    
                    <!-- Stock Indicator -->
                    {% if v.stock > 0 %}
                      {% if v.stock <= 10 %}
                        <div class="mt-2 flex items-center text-red-600 text-sm font-medium">
                          <i class="fas fa-exclamation-triangle mr-2"></i>
                          Only {{ v.stock }} left in stock!
                        </div>
                      {% else %}
                        <div class="mt-2 flex items-center text-green-600 text-sm font-medium">
                          <i class="fas fa-check-circle mr-2"></i>
                          In Stock
                        </div>
                      {% endif %}
                    {% endif %}
                  </div>

                  <!-- Action Buttons -->
                  <div class="flex flex-col gap-2 min-w-[140px]">
                    {% if v.id in cart_items %}
                      <a href="{% url 'cart_view' %}" 
                         class="flex items-center justify-center space-x-2 px-6 py-3 bg-blue-600 text-white rounded-xl font-semibold hover:bg-blue-700 transition shadow-lg">
                        <i class="fas fa-shopping-cart"></i>
                        <span>View Cart</span>
                      </a>
                    {% else %}
                      {% if v.stock == 0 %}
                        <button disabled 
                                class="flex items-center justify-center space-x-2 px-6 py-3 bg-gray-300 text-gray-500 rounded-xl font-semibold cursor-not-allowed">
                          <i class="fas fa-times-circle"></i>
                          <span>Out of Stock</span>
                        </button>
                      {% else %}
                        <a href="{% url 'add_to_cart' v.id %}" 
                           class="flex items-center justify-center space-x-2 px-6 py-3 bg-emerald-500 to-emerald-600 text-white rounded-xl font-semibold hover:from-emerald-600 hover:to-emerald-700 transition shadow-lg">
                          <i class="fas fa-cart-plus"></i>
                          <span>Add to Cart</span>
                        </a>
                      {% endif %}
                    {% endif %}
                  </div>
                </div>
              </div>
              {% empty %}
                <div class="text-center py-8">
                  <i class="fas fa-box-open text-gray-300 text-5xl mb-3"></i>
                  <p class="text-gray-500 text-lg">No variants available at the moment</p>
                </div>
              {% endfor %}
            </div>
          </div>

        </div>
      </div>

      <!-- Reviews Section -->
      <div class="mt-16 bg-white rounded-3xl shadow-2xl p-8 fade-in">
        <h2 class="text-3xl font-bold text-center text-gray-800 mb-8 flex items-center justify-center">
          <i class="fas fa-star text-yellow-400 mr-3"></i>
          Customer Reviews & Ratings
        </h2>

        <!-- Average Rating Display -->
        <div class="bg-gradient-to-r from-yellow-50 to-orange-50 rounded-2xl p-8 mb-8">
          <div class="flex flex-col md:flex-row items-center justify-center gap-8">
            <div class="text-center">
              <div class="text-6xl font-bold text-gray-800 mb-2">{{ product.avg_rating|floatformat:1 }}</div>
              <div class="flex items-center justify-center space-x-1 mb-2">
                {% for i in "12345" %}
                  {% if i|add:"0" <= product.avg_rating %}
                    <i class="fas fa-star text-yellow-400 text-lg"></i>
                  {% else %}
                    <i class="far fa-star text-gray-300 text-lg"></i>
                  {% endif %}
                {% endfor %}
              </div>
              <p class="text-gray-600 font-medium">Based on {{ product.rating_count }} reviews</p>
            </div>
          </div>
        </div>

        <!-- Review Form -->
        {% if user.is_authenticated %}
        <div class="bg-gradient-to-br from-blue-50 to-purple-50 rounded-2xl p-6 mb-8">
          <form method="POST" action="">
            {% csrf_token %}
            
            <!-- Star Rating -->
            <div class="mb-6">
              <div class="flex justify-center star-rating flex-row-reverse space-x-reverse space-x-2">
                {% for i in "54321" %}
                  <input type="radio" name="rating" id="star{{ i }}" value="{{ i }}" class="hidden peer/star{{ i }}">
                  <label for="star{{ i }}" 
                         class="text-5xl cursor-pointer text-gray-300 hover:text-yellow-400 peer-checked/star{{ i }}:text-yellow-400 transition-all transform hover:scale-110">
                    ★
                  </label>
                {% endfor %}
              </div>
            </div>

            <!-- Comment -->
            <div class="mb-4">
              <label class="font-semibold text-gray-700 mb-2 block">Your Review:</label>
              <textarea name="comment" 
                        rows="4" 
                        class="w-full border-2 border-gray-300 focus:border-blue-500 rounded-xl p-4 focus:ring-4 focus:ring-blue-100 transition" 
                        placeholder="Share your experience with this product...">{{ request.POST.comment }}</textarea>
            </div>

            <button type="submit" 
                    class="w-full md:w-auto px-8 py-3  bg-emerald-500 to-green-600 text-white rounded-xl font-semibold hover:from-green-600 hover:to-green-700 transition shadow-lg flex items-center justify-center space-x-2">
              <i class="fas fa-paper-plane"></i>
              <span>Submit Review</span>
            </button>
          </form>
        </div>
        {% else %}
        <div class="bg-blue-50 border-2 border-blue-200 rounded-2xl p-6 mb-8 text-center">
          <i class="fas fa-user-lock text-blue-600 text-4xl mb-3"></i>
          <p class="text-gray-700 mb-3 text-lg">Please log in to write a review</p>
          <a href="{% url 'login' %}?next={{ request.path }}" 
             class="inline-flex items-center space-x-2 px-6 py-3 bg-blue-600 text-white rounded-xl font-semibold hover:bg-blue-700 transition">
            <i class="fas fa-sign-in-alt"></i>
            <span>Login Now</span>
          </a>
        </div>
        {% endif %}

        <!-- Reviews List -->
        <div class="space-y-4">
          <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
            <i class="fas fa-comments text-purple-600 mr-2"></i>
            Customer Feedback
          </h3>
          
          {% if reviews %}
            {% for r in reviews %}
            <div class="bg-gray-50 rounded-xl p-6 border border-gray-200 hover:shadow-lg transition">
              <div class="flex items-start justify-between mb-3">
                <div class="flex items-center space-x-3">
                  <div class="w-12 h-12 bg-[linear-gradient(135deg,#3b82f6,#8b5cf6)] rounded-full flex items-center justify-center text-white font-bold text-lg">
                    {{ r.user.get_full_name|first|upper }}
                  </div>
                  <div>
                    <p class="font-semibold text-gray-800">{{ r.user.get_full_name }}</p>
                    <div class="flex items-center space-x-2">
                      <div class="flex">
                        {% for i in "12345" %}
                          {% if i|add:"0" <= r.rating %}
                            <i class="fas fa-star text-yellow-400 text-sm"></i>
                          {% else %}
                            <i class="far fa-star text-gray-300 text-sm"></i>
                          {% endif %}
                        {% endfor %}
                      </div>
                      <span class="text-sm text-gray-500">{{ r.created_at|date:"d M Y" }}</span>
                    </div>
                  </div>
                </div>
                <span class="px-3 py-1 bg-green-100 text-green-700 rounded-full text-xs font-semibold">
                  <i class="fas fa-check-circle mr-1"></i>Verified Purchase
                </span>
              </div>
              <p class="text-gray-700 leading-relaxed">{{ r.comment }}</p>
            </div>
            {% endfor %}
          {% else %}
            <div class="text-center py-12">
              <i class="fas fa-comment-slash text-gray-300 text-6xl mb-4"></i>
              <p class="text-gray-500 text-xl font-medium">No reviews yet</p>
              <p class="text-gray-400 mt-2">Be the first to review this product!</p>
            </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
  // Show real content after loading
  setTimeout(() => {
    document.getElementById('skeleton-content').classList.add('hidden');
    document.getElementById('real-content').classList.remove('hidden');
  }, 800);

  // Image Gallery
  const mainImg = document.getElementById("main-product-image");
  const thumbs = document.querySelectorAll(".thumb-img");

  thumbs.forEach(thumb => {
    thumb.addEventListener("click", function() {
      mainImg.src = this.src;
      thumbs.forEach(t => {
        t.classList.remove("border-blue-600");
        t.classList.add("border-gray-200");
      });
      this.classList.remove("border-gray-200");
      this.classList.add("border-blue-600");
    });
  });

  // Advanced zoom effect
  const container = mainImg.parentElement;
  
  mainImg.addEventListener("mousemove", function(e) {
    const rect = mainImg.getBoundingClientRect();
    const x = ((e.clientX - rect.left) / rect.width) * 100;
    const y = ((e.clientY - rect.top) / rect.height) * 100;
    mainImg.style.transformOrigin = `${x}% ${y}%`;
    mainImg.style.transform = "scale(2)";
  });

  mainImg.addEventListener("mouseleave", function() {
    mainImg.style.transformOrigin = "center center";
    mainImg.style.transform = "scale(1)";
  });

  // Star rating hover effect
  const starInputs = document.querySelectorAll('.star-rating input[type="radio"]');
  const starLabels = document.querySelectorAll('.star-rating label');
  
  starLabels.forEach((label, index) => {
    label.addEventListener('mouseenter', () => {
      for(let i = starLabels.length - 1; i >= index; i--) {
        starLabels[i].style.color = '#fbbf24';
      }
    });
  });
  
  document.querySelector('.star-rating')?.addEventListener('mouseleave', () => {
    starLabels.forEach(label => {
      if(!label.previousElementSibling?.checked) {
        label.style.color = '';
      }
    });
  });
});
</script>
{% endblock %}