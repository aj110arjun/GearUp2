{% extends "user/base.html" %}
{% load static %}
{% block title %}Products{% endblock %}

{% block content %}
<div class="container mx-auto my-6 px-4">

  <!-- 🔍 Search & Filters -->
  <div class="flex flex-wrap gap-4 mb-6 items-center">
    <form method="get" class="flex flex-wrap gap-4 w-full">
      <!-- Search -->
      <div class="relative flex-1 min-w-[250px]">
        <input type="text" name="q" id="search-input"
          class="w-full border border-gray-300 rounded-lg py-2 px-4 pr-14 focus:outline-none focus:ring-2 focus:ring-blue-500"
          placeholder="Search products..." value="{{ filters.search }}">
        <button type="button" id="clear-btn" aria-label="Clear search"
          class="absolute right-14 top-1/2 -translate-y-1/2 text-gray-400 text-xl hidden">&times;</button>
        <button type="submit"
          class="absolute right-2 top-1/2 -translate-y-1/2 bg-blue-600 text-white px-3 py-1 rounded-md text-sm hover:bg-blue-700">
          Search
        </button>
      </div>

      <!-- Category filter -->
      <div>
        <select name="category"
          class="border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-blue-500"
          onchange="this.form.submit()">
          <option value="">All Categories</option>
          {% for cat in categories %}
          <option value="{{ cat.id }}" {% if filters.category == cat.id|stringformat:"s" %}selected{% endif %}>
            {{ cat.name }}
          </option>
          {% endfor %}
        </select>
      </div>

      <!-- Sorting -->
      <div>
        <select name="sort"
          class="border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-blue-500"
          onchange="this.form.submit()">
          <option value="">Sort by</option>
          <option value="name" {% if filters.sort == "name" %}selected{% endif %}>Name: A-Z</option>
          <option value="name2" {% if filters.sort == "name2" %}selected{% endif %}>Name: Z-A</option>
          <option value="price_asc" {% if filters.sort == "price_asc" %}selected{% endif %}>Price: Low to High</option>
          <option value="price_desc" {% if filters.sort == "price_desc" %}selected{% endif %}>Price: High to Low</option>
        </select>
      </div>

      <!-- Clear Filters -->
      <div class="ml-auto">
        {% if filters.search or filters.category or filters.sort %}
        <a href="{% url 'product_list' %}"
          class="border border-gray-400 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-100">
          Clear Filters
        </a>
        {% endif %}
      </div>
    </form>
  </div>

  <!-- 🦴 Skeleton Loader -->
  <div id="product-skeletons" class="grid grid-cols-2 md:grid-cols-4 gap-6">
    {% for i in "12345678" %}
    <div class="flex flex-col bg-white rounded-xl shadow p-3 animate-pulse">
      <div class="bg-gray-300 h-48 rounded-xl mb-3"></div>
      <div class="bg-gray-300 h-4 w-3/4 mx-auto mb-2 rounded"></div>
      <div class="bg-gray-300 h-4 w-1/3 mx-auto mb-3 rounded"></div>
      <div class="bg-gray-300 h-7 w-1/2 mx-auto rounded-md"></div>
    </div>
    {% endfor %}
  </div>

  <!-- 🛍️ Product Grid -->
  <div id="product-grid" class="hidden grid grid-cols-2 md:grid-cols-4 gap-6">
    {% if products %}
    {% for product in products %}
    <div class="flex flex-col bg-white rounded-2xl shadow-md hover:shadow-xl transition transform hover:-translate-y-1 hover:scale-[1.02] p-4 h-full">
        <!-- Image -->
        <div class="relative rounded-xl overflow-hidden h-48 mb-3">
            {% if product.image %}
            <img src="{{ product.image.url }}" class="w-full h-full object-cover transition-transform duration-300 hover:scale-105" alt="{{ product.name }}">
            {% else %}
            <img src="{% static 'images/placeholder.png' %}" class="w-full h-full object-cover" alt="No image">
            {% endif %}
            {% if product.best_offer %}
            <span class="absolute top-2 left-2 bg-red-500 text-white text-xs font-semibold px-2 py-1 rounded-lg shadow">
                {{ product.best_offer.discount_percent }}% OFF
            </span>
            {% endif %}
        </div>

        <!-- Body -->
        <div class="flex flex-col flex-grow">
            <h6 class="font-semibold truncate mb-1">{{ product.name }}</h6>

            {% if product.variants.all %}
            <p class="text-gray-700 mb-2 text-sm">
                From <span class="font-bold">₹{{ product.variants.all.0.price }}</span>
            </p>
            {% else %}
            <p class="text-gray-400 text-sm mb-2">No variants available</p>
            {% endif %}

            <div class="mt-auto space-y-2">
            <a href="{% url 'product_detail' product.product_id %}"
                class="block text-center w-full border border-blue-600 text-blue-600 py-1.5 rounded-lg hover:bg-blue-600 hover:text-white font-medium transition">
                View Details
            </a>

            <div class="flex gap-3 justify-center">
                <!-- Cart -->
                <form action="{% url 'add_to_cart' product.id %}" method="POST"
                    class="toggle-cart-form flex-1" data-variant-id="{{ product.variants.first.id }}">
                {% csrf_token %}
                <button type="button"
                        class="cart-btn w-full py-2 rounded-full text-white {% if product.variants.first.id in cart_variant_ids %}bg-green-600{% else %}bg-gray-800{% endif %} hover:opacity-90 transition flex justify-center items-center gap-2"
                        data-product-id="{{ product.id }}" data-variant-id="{{ product.variants.first.id }}"
                        title="{% if product.variants.first.id in cart_variant_ids %}Remove from Cart{% else %}Add to Cart{% endif %}">
                    <i class="bi {% if product.variants.first.id in cart_variant_ids %}bi-check2{% else %}bi-cart3{% endif %} text-lg"></i>
                </button>
                </form>

                <!-- Wishlist -->
                <form method="POST" action="{% url 'remove_from_wishlist' product.id %}" class="flex-1">
                {% csrf_token %}
                <button type="button"
                        class="wishlist-btn w-full py-2 rounded-full border {% if product.id in wishlist_ids %}bg-red-600 text-white{% else %}border-red-500 text-red-500{% endif %} hover:opacity-90 transition flex justify-center items-center gap-2"
                        data-product-id="{{ product.id }}"
                        title="{% if product.id in wishlist_ids %}Remove from Wishlist{% else %}Add to Wishlist{% endif %}">
                    <i class="bi {% if product.id in wishlist_ids %}bi-heart-fill{% else %}bi-heart{% endif %} text-lg"></i>
                </button>
                </form>
            </div>
            </div>
        </div>
    </div>

    {% endfor %}
    {% else %}
    <p class="col-span-full text-center text-gray-500">No products found.</p>
    {% endif %}
  </div>

  <!-- Pagination -->
  {% if products.has_other_pages %}
  <nav aria-label="Page navigation" class="mt-8">
    <ul class="flex justify-center gap-2">
      {% if products.has_previous %}
      <li>
        <a class="px-3 py-1 border rounded-md hover:bg-gray-200"
          href="?page={{ products.previous_page_number }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}{% if request.GET.category %}&category={{ request.GET.category }}{% endif %}{% if request.GET.sort %}&sort={{ request.GET.sort }}{% endif %}">
          &laquo;
        </a>
      </li>
      {% else %}
      <li><span class="px-3 py-1 border rounded-md text-gray-400">&laquo;</span></li>
      {% endif %}

      {% for i in products.paginator.page_range %}
      {% if products.number == i %}
      <li><span class="px-3 py-1 bg-blue-600 text-white rounded-md">{{ i }}</span></li>
      {% else %}
      <li><a class="px-3 py-1 border rounded-md hover:bg-gray-200"
          href="?page={{ i }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}{% if request.GET.category %}&category={{ request.GET.category }}{% endif %}{% if request.GET.sort %}&sort={{ request.GET.sort }}{% endif %}">{{ i }}</a>
      </li>
      {% endif %}
      {% endfor %}

      {% if products.has_next %}
      <li>
        <a class="px-3 py-1 border rounded-md hover:bg-gray-200"
          href="?page={{ products.next_page_number }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}{% if request.GET.category %}&category={{ request.GET.category }}{% endif %}{% if request.GET.sort %}&sort={{ request.GET.sort }}{% endif %}">
          &raquo;
        </a>
      </li>
      {% else %}
      <li><span class="px-3 py-1 border rounded-md text-gray-400">&raquo;</span></li>
      {% endif %}
    </ul>
  </nav>
  {% endif %}
</div>

<!-- 🔧 Scripts (unchanged) -->
<script>
  document.addEventListener('DOMContentLoaded', function() {
    setTimeout(function() {
      document.getElementById('product-skeletons').style.display = 'none';
      document.getElementById('product-grid').style.display = 'grid';
    }, 1000);
  });

  const input = document.getElementById('search-input');
  const clearBtn = document.getElementById('clear-btn');

  function toggleClearBtn() {
    clearBtn.style.display = input.value ? 'block' : 'none';
  }

  input.addEventListener('input', toggleClearBtn);
  clearBtn.addEventListener('click', () => {
    input.value = '';
    toggleClearBtn();
    input.focus();
  });
  toggleClearBtn();

  document.addEventListener('DOMContentLoaded', () => {
    const wishlistButtons = document.querySelectorAll('.wishlist-btn');
    wishlistButtons.forEach(button => {
      button.addEventListener('click', async () => {
        const productId = button.dataset.productId;
        try {
          const response = await fetch("{% url 'toggle_wishlist' 0 %}".replace('0', productId), {
            method: 'POST',
            headers: {
              'X-CSRFToken': '{{ csrf_token }}',
              'X-Requested-With': 'XMLHttpRequest',
            },
          });
          const data = await response.json();
          if (data.status === 'added') {
            button.classList.remove('border', 'border-red-500', 'text-red-500');
            button.classList.add('bg-red-600', 'text-white');
            button.querySelector('i').classList.remove('bi-heart');
            button.querySelector('i').classList.add('bi-heart-fill');
          } else if (data.status === 'removed') {
            button.classList.add('border', 'border-red-500', 'text-red-500');
            button.classList.remove('bg-red-600', 'text-white');
            button.querySelector('i').classList.remove('bi-heart-fill');
            button.querySelector('i').classList.add('bi-heart');
          }
        } catch (error) {
          console.error('Error toggling wishlist:', error);
        }
      });
    });
  });

  document.addEventListener("DOMContentLoaded", function () {
    document.querySelectorAll(".cart-btn").forEach(button => {
      button.addEventListener("click", function () {
        const btn = this;
        const productId = btn.getAttribute("data-product-id");
        const variantId = btn.getAttribute("data-variant-id");

        fetch("{% url 'toggle_cart' %}", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": "{{ csrf_token }}",
          },
          body: JSON.stringify({
            product_id: productId,
            variant_id: variantId,
          }),
        })
        .then(response => response.json())
        .then(data => {
          if (data.added) {
            btn.classList.remove("bg-gray-800");
            btn.classList.add("bg-green-600");
            btn.querySelector("i").classList.replace("bi-cart3", "bi-check2");
          } else if (data.removed) {
            btn.classList.add("bg-gray-800");
            btn.classList.remove("bg-green-600");
            btn.querySelector("i").classList.replace("bi-check2", "bi-cart3");
          }
        });
      });
    });
  });
</script>
{% endblock %}
