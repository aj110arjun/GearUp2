{% extends 'user/base.html' %}
{% load static %}

{% block title %}Products{% endblock %}


{% block content %}
            <div class="container my-4">

                <!-- Search & Filters Row -->
                <div class="row mb-4 align-items-center">
                    <!-- Search -->
                    <form method="get" class="row g-2 align-items-center mb-4">

                        <!-- Search (text input) -->
                        <div class="col-md-4 position-relative">
            <div class="input-group">
                <input type="text" name="q" id="search-input" class="form-control" placeholder="Search products..." value="{{ filters.search }}"
                    style="padding-right: 60px;"> <!-- Add right padding -->

                <!-- Clear button positioned to the left of the search button -->
                <button type="button" id="clear-btn" aria-label="Clear search"
                        style="
                        position: absolute;
                        right: 75px; /* Move left of search button */
                        top: 50%;
                        transform: translateY(-50%);
                        border: none;
                        background: transparent;
                        font-size: 18px;
                        cursor: pointer;
                        color: #999;
                        display: none;
                        z-index: 1000;
                        ">
                &times;
                </button>

                <button type="submit" class="btn btn-primary">Search</button>
            </div>
            </div>
            <!-- Category filter -->
            <div class="col-md-3">
                <select name="category" class="form-select" onchange="this.form.submit()">
                <option value="">All Categories</option>
                {% for cat in categories %}
                    <option value="{{ cat.id }}" {% if filters.category == cat.id|stringformat:"s" %}selected{% endif %}>{{ cat.name }}</option>
                {% endfor %}
                </select>
            </div>

            <!-- Sorting -->
            <div class="col-md-3">
                <select name="sort" class="form-select" onchange="this.form.submit()">
                <option value="">Sort by</option>
                <option value="name" {% if filters.sort == "name" %}selected{% endif %}>Name: A-Z</option>
                <option value="name2" {% if filters.sort == "name2" %}selected{% endif %}>Name: Z-A</option>
                <option value="price_asc" {% if filters.sort == "price_asc" %}selected{% endif %}>Price: Low to High</option>
                <option value="price_desc" {% if filters.sort == "price_desc" %}selected{% endif %}>Price: High to Low</option>
                </select>
            </div>

        </form>


    <!-- Product Grid -->
    <!-- Product Grid -->
<div class="row g-4">
    {% if products %}
        {% for product in products %}
            <div class="col-6 col-md-3">
                <div class="card h-100 shadow-sm d-flex flex-column">

                    <!-- Product Image -->
                    {% if product.image %}
                        <img src="{{ product.image.url }}" class="card-img-top" alt="{{ product.name }}">
                    {% else %}
                        <img src="{% static 'images/placeholder.png' %}" class="card-img-top" alt="No image">
                    {% endif %}

                    <!-- Card Body -->
                    <div class="card-body d-flex flex-column">
                        <h6 class="card-title text-truncate">{{ product.name }}</h6>

                        <!-- Offer Badge -->
                        {% if product.best_offer %}
                            <span class="badge bg-danger align-self-start mb-2">
                                {{ product.best_offer.discount_percent }}% OFF
                            </span>
                        {% endif %}

                        <!-- Price -->
                        {% if product.variants.all %}
                            <p class="card-text mb-2">
                                From <strong>â‚¹{{ product.variants.all.0.price }}</strong>
                            </p>
                        {% else %}
                            <p class="text-muted mb-2">No variants available</p>
                        {% endif %}

                        <!-- Spacer pushes button to bottom -->
                        <div class="mt-auto">
                            <a href="{% url 'product_detail' product.product_id %}"
                               class="btn btn-outline-primary btn-sm w-100">
                                View Details
                            </a>
                        </div>
                        <div class="d-flex gap-2 mt-3 justify-content-center text-center">
                            <!-- Add to Cart -->
                            <form acion="{% url 'add_to_cart' product.id %}" method="POST" class="flex-fill toggle-cart-form" data-variant-id="{{ product.variants.first.id }}">
                                {% csrf_token %}
                                <button type="button"
                                    class="btn cart-btn {% if product.variants.first.id in cart_variant_ids %}btn-success{% else %}btn-dark{% endif %} btn-circle"
                                    data-product-id="{{ product.id }}"
                                    data-variant-id="{{ product.variants.first.id }}"
                                    title="{% if product.variants.first.id in cart_variant_ids %}Remove from Cart{% else %}Add to Cart{% endif %}">
                                <i class="bi {% if product.variants.first.id in cart_variant_ids %}bi-check2{% else %}bi-cart3{% endif %} fs-5"></i>
                            </button>
                            </form>

                            <!-- Add to Wishlist -->
                                <form method="POST" action="{% url 'remove_from_wishlist' product.id %}" class="flex-fill">
                                {% csrf_token %}
                                    <button type="button" class="btn wishlist-btn {% if product.id in wishlist_ids %}btn-danger{% else %}btn-outline-danger{% endif %} btn-circle"
                                            data-product-id="{{ product.id }}"
                                            title="{% if product.id in wishlist_ids %}Remove from Wishlist{% else %}Add to Wishlist{% endif %}">
                                        <i class="bi {% if product.id in wishlist_ids %}bi-heart-fill{% else %}bi-heart{% endif %} fs-5"></i>
                                    </button>
                                </form> 
                        </div>
                    </div>
                </div>
            </div>
        {% endfor %}
    {% else %}
        <p>No products found.</p>
    {% endif %}
</div>


    <!-- Pagination -->
    {% if products.has_other_pages %}
    <nav aria-label="Page navigation" class="mt-4">
        <ul class="pagination justify-content-center">
            {% if products.has_previous %}
            <li class="page-item">
                <a class="page-link" href="?page={{ products.previous_page_number }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}{% if request.GET.category %}&category={{ request.GET.category }}{% endif %}{% if request.GET.sort %}&sort={{ request.GET.sort }}{% endif %}" aria-label="Previous">
                    <span aria-hidden="true">&laquo;</span>
                </a>
            </li>
            {% else %}
            <li class="page-item disabled"><span class="page-link">&laquo;</span></li>
            {% endif %}

            {% for i in products.paginator.page_range %}
                {% if products.number == i %}
                    <li class="page-item active"><span class="page-link">{{ i }}</span></li>
                {% else %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ i }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}{% if request.GET.category %}&category={{ request.GET.category }}{% endif %}{% if request.GET.sort %}&sort={{ request.GET.sort }}{% endif %}">{{ i }}</a>
                    </li>
                {% endif %}
            {% endfor %}

            {% if products.has_next %}
            <li class="page-item">
                <a class="page-link" href="?page={{ products.next_page_number }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}{% if request.GET.category %}&category={{ request.GET.category }}{% endif %}{% if request.GET.sort %}&sort={{ request.GET.sort }}{% endif %}" aria-label="Next">
                    <span aria-hidden="true">&raquo;</span>
                </a>
            </li>
            {% else %}
            <li class="page-item disabled"><span class="page-link">&raquo;</span></li>
            {% endif %}
        </ul>
    </nav>
    {% endif %}

</div>

<script>
  const input = document.getElementById('search-input');
  const clearBtn = document.getElementById('clear-btn');

  function toggleClearBtn() {
    clearBtn.style.display = input.value ? 'block' : 'none';
  }

  input.addEventListener('input', toggleClearBtn);
  clearBtn.addEventListener('click', () => {
    input.value = '';
    toggleClearBtn();
    input.focus();
  });

  // Initialize on page load
  toggleClearBtn();

  document.addEventListener('DOMContentLoaded', () => {
  const wishlistButtons = document.querySelectorAll('.wishlist-btn');

  wishlistButtons.forEach(button => {
    button.addEventListener('click', async () => {
      const productId = button.dataset.productId;

      try {
        const response = await fetch("{% url 'toggle_wishlist' 0 %}".replace('0', productId), {
          method: 'POST',
          headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'X-Requested-With': 'XMLHttpRequest',
          },
        });

        const data = await response.json();

        if (data.status === 'added') {
          button.classList.remove('btn-outline-danger');
          button.classList.add('btn-danger');
          button.querySelector('i').classList.remove('bi-heart');
          button.querySelector('i').classList.add('bi-heart-fill');
          button.title = 'Remove from Wishlist';
        } else if (data.status === 'removed') {
          button.classList.remove('btn-danger');
          button.classList.add('btn-outline-danger');
          button.querySelector('i').classList.remove('bi-heart-fill');
          button.querySelector('i').classList.add('bi-heart');
          button.title = 'Add to Wishlist';
        }
      } catch (error) {
        console.error('Error toggling wishlist:', error);
      }
    });
  });
});

document.addEventListener("DOMContentLoaded", function () {
    document.querySelectorAll(".cart-btn").forEach(button => {
        button.addEventListener("click", function () {
            const btn = this;
            const productId = btn.getAttribute("data-product-id");
            const variantId = btn.getAttribute("data-variant-id");
            
            fetch("{% url 'toggle_cart' %}", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": "{{ csrf_token }}",
                },
                body: JSON.stringify({
                    product_id: productId,
                    variant_id: variantId,
                }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.added) {
                    // Added to cart
                    btn.classList.remove("btn-dark");
                    btn.classList.add("btn-success");
                    btn.setAttribute("title", "Remove from Cart");
                    btn.querySelector("i").classList.remove("bi-cart3");
                    btn.querySelector("i").classList.add("bi-check2");
                } else if (data.removed) {
                    // Removed from cart
                    btn.classList.remove("btn-success");
                    btn.classList.add("btn-dark");
                    btn.setAttribute("title", "Add to Cart");
                    btn.querySelector("i").classList.remove("bi-check2");
                    btn.querySelector("i").classList.add("bi-cart3");
                }
            });
        });
    });
});


</script>
{% endblock %}
